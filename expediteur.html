<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exp√©diteur - Exp√©dier un colis</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }

    h1 {
      color: #007bff;
    }

    .form-container {
      display: none;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 600px;
      margin-top: 20px;
    }

    label {
      display: block;
      margin: 10px 0 5px;
    }

    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .success {
      color: green;
      margin-top: 20px;
    }

    .error {
      color: red;
    }
  </style>
</head>
<body>

    <h1>Bienvenue, Exp√©diteur  üëã</h1>

    <p id="location-status">üîÑ R√©cup√©ration de votre position en cours...</p>
    
    <button id="show-form">üì¶ Exp√©dier un colis</button>
    
    <div class="form-container" id="expedition-form" style="display: none;">
      <h2>Formulaire d'exp√©dition</h2>
    
      <form id="form">
        <!-- Nom de l'exp√©diteur -->
        <label for="sender">Nom de l'exp√©diteur</label>
        <input type="text" id="sender" name="sender" required placeholder="Votre nom">
    
        <!-- T√©l√©phone de l'exp√©diteur -->
        <label for="phone1">T√©l√©phone de l'exp√©diteur</label>
        <input type="tel" id="phone1" name="phone1" required placeholder="Ex: +226 76 00 00 00">
    
        <!-- Nom du destinataire -->
        <label for="recipient">Nom du destinataire</label>
        <input type="text" id="recipient" name="recipient" required placeholder="Ex: Jean Kabor√©">
    
        <!-- T√©l√©phone du destinataire -->
        <label for="phone">T√©l√©phone du destinataire</label>
        <input type="tel" id="phone" name="phone" required placeholder="Ex: +226 70 00 00 00">
    
        <!-- Adresse de livraison -->
        <label for="address">Adresse de livraison</label>
        <input type="text" id="address" name="address" required placeholder="Ex: Quartier Pissy, Karpala, Goughin...">
    
        <!-- Type de colis -->
        <label for="type">Type de colis</label>
        <select id="type" name="type" required>
          <option value="">-- Choisissez --</option>
          <option value="alimentaire">Alimentaire</option>
          <option value="fragile">Fragile</option>
          <option value="sante">Sant√©</option>
          <option value="document">Document</option>
          <option value="autre">Autre</option>
        </select>
    
        <!-- D√©tails suppl√©mentaires -->
        <label for="details">D√©tails suppl√©mentaires</label>
        <textarea id="details" name="details" rows="4" placeholder="Ex: Poids, dimensions, contenu, consignes..."></textarea>
    
        <!-- Joindre des photos -->
        <label for="photos">Joindre 2 photos max</label>
        <input type="file" id="photos" name="photos" accept="image/*" multiple required>
    
        <!-- Localisation automatique -->
        <label for="location">Votre localisation actuelle</label>
        <input type="text" id="location" name="location" readonly placeholder="Chargement...">
    
        <!-- Bouton de soumission -->
        <button type="submit">üöÄ Exp√©dier</button>
      </form>
    
      <!-- Messages -->
      <p class="success" id="success-msg"></p>
      <p class="error" id="error-msg"></p>
    </div>
    
    <script>
      let userLocation = null;
    
      // Obtenir la g√©olocalisation
      window.onload = () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              userLocation = {
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude
              };
              document.getElementById("location-status").textContent = "üìç Position enregistr√©e.";
              document.getElementById("location").value = `${userLocation.latitude}, ${userLocation.longitude}`;
            },
            () => {
              document.getElementById("location-status").textContent = "‚ùå Impossible d‚Äôobtenir la position.";
            }
          );
        }
      };
    
      // Afficher le formulaire
      document.getElementById("show-form").addEventListener("click", () => {
        document.getElementById("expedition-form").style.display = "block";
      });
    
      // G√©n√©rer un ID colis unique
      function generateID() {
        return Math.random().toString(36).substring(2, 10).toUpperCase();
      }
    
      // Convertir une image en base64
      function toBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(error);
        });
      }
    
      // Soumission du formulaire
      document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
    
        const sender = document.getElementById("sender").value;
        const phone1 = document.getElementById("phone1").value;
        const recipient = document.getElementById("recipient").value;
        const phone = document.getElementById("phone").value;
        const address = document.getElementById("address").value;
        const type = document.getElementById("type").value;
        const details = document.getElementById("details").value;
        const files = document.getElementById("photos").files;
    
        if (files.length > 2) {
          document.getElementById("error-msg").textContent = "‚ùå Vous ne pouvez joindre que 2 photos.";
          return;
        }
    
        // Convertir les fichiers en base64
        const photosBase64 = [];
        for (const file of files) {
          const base64 = await toBase64(file);
          photosBase64.push(base64);
        }
    
        const colisID = generateID();
    
        const data = {
          colisID,
          sender,
          phone1,
          recipient,
          phone,
          address,
          type,
          details,
          location: userLocation,
          photos: photosBase64
        };
    
        try {
          const res = await fetch('/.netlify/functions/expedi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
    
          const result = await res.json();
    
          if (res.ok) {
            document.getElementById("success-msg").textContent = `‚úÖ Colis exp√©di√© avec succ√®s ! ID : ${colisID}`;
            document.getElementById("error-msg").textContent = '';
            document.getElementById("form").reset();
          } else {
            document.getElementById("error-msg").textContent = result.message || "‚ùå Erreur lors de l‚Äôenvoi.";
          }
        } catch (err) {
          document.getElementById("error-msg").textContent = "‚ùå Erreur r√©seau ou serveur.";
        }
      });
    </script>
    

</body>
</html>
