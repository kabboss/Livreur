<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inscription - Livreur2.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="inscrip.css">

</head>
<body>
    <div class="container">
        <div class="navigation-arrows">
            <a href="Connection.html" class="arrow left-arrow" aria-label="Page précédente">
                <i class="fas fa-arrow-left"></i>
            </a>
            <a href="index.html" class="arrow home-button" aria-label="Page d'accueil">
                <i class="fas fa-home"></i>
            </a>
            <button class="arrow refresh-button" aria-label="Actualiser la page" onclick="location.reload();">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <img src="img/ChatGPT Image 30 avr. 2025, 20_34_02.png" alt="Logo Livreur 2.0" class="logo-img">
        <form id="registerForm" class="form">
            <label for="username">
                <i class="fas fa-user"></i> Nom d'utilisateur *
            </label>
            <input type="text" id="username" name="username" placeholder="Votre nom d'utilisateur" required>

            <label for="whatsapp">
                <i class="fab fa-whatsapp"></i> Numéro WhatsApp *
            </label>
            <input type="tel" id="whatsapp" name="whatsapp" placeholder="Ex: 70123456" required>

            <label for="secondNumber">
                <i class="fas fa-phone-alt"></i> Deuxième numéro (optionnel)
            </label>
            <input type="tel" id="secondNumber" name="secondNumber" placeholder="Ex: 70123456">

            <label for="type">
                <i class="fas fa-user-tag"></i> Type de compte *
            </label>
            <select id="type" name="type" required onchange="toggleCodeField()">
                <option value="">-- Choisir un type --</option>
                <option value="client">Client</option>
                <option value="expediteur">Expéditeur</option>
                <option value="livreur">Livreur</option>
                <option value="admin">Administrateur</option>
            </select>

            <div id="codeField" style="display: none;">
                <label for="code">
                    <i class="fas fa-key"></i> Code d'identification *
                </label>
                <input type="text" id="code" name="code" placeholder="Code fourni">
            </div>

            <label for="password">
                <i class="fas fa-lock"></i> Mot de passe *
            </label>
            <input type="password" id="password" name="password" placeholder="Minimum 6 caractères" required minlength="6">

            <label for="confirmPassword">
                <i class="fas fa-lock"></i> Confirmer le mot de passe *
            </label>
            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Retapez votre mot de passe" required>

            <button type="submit" class="btn">
                <i class="fas fa-user-plus"></i> S'inscrire
            </button>
        </form>

        <div id="message"></div>
    </div>

    <script>
        function toggleCodeField() {
            const type = document.getElementById('type').value;
            const codeField = document.getElementById('codeField');
            const codeInput = document.getElementById('code');
            
            if (type === 'livreur' || type === 'admin') {
                codeField.style.display = 'block';
                codeInput.required = true;
            } else {
                codeField.style.display = 'none';
                codeInput.required = false;
                codeInput.value = '';
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type} animate__animated animate__fadeInRight`;
            toast.innerHTML = `${message}<span class="close-btn">&times;</span>`;
            
            document.body.appendChild(toast);
            
            // Fermer le toast après 4 secondes
            setTimeout(() => {
                toast.classList.remove('animate__fadeInRight');
                toast.classList.add('animate__fadeOutRight');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
            
            // Fermer au clic
            toast.querySelector('.close-btn').addEventListener('click', () => {
                toast.classList.remove('animate__fadeInRight');
                toast.classList.add('animate__fadeOutRight');
                setTimeout(() => toast.remove(), 300);
            });
        }

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Validation côté client
            if (data.password !== data.confirmPassword) {
                showToast('Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            if ((data.type === 'livreur' || data.type === 'admin') && !data.code) {
                showToast('Le code d\'identification est requis pour ce type de compte', 'warning');
                return;
            }
            
            try {
                const response = await fetch('https://livreur2.netlify.app/.netlify/functions/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast(result.message || 'Inscription réussie!', 'success');
                    form.reset();
                    
                    if (result.redirect) {
                        setTimeout(() => {
                            window.location.href = result.redirect;
                        }, 1500);
                    }
                } else {
                    showToast(result.message || 'Erreur lors de l\'inscription', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showToast('Erreur de connexion au serveur', 'error');
            }
        });
        
        // Initialiser le champ code au chargement
        toggleCodeField();
    </script>
</body>
</html>