<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Suivi de colis en temps r√©el">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <title>Suivi Colis | Plateforme de livraison</title>
 
  <link rel="stylesheet" href="client.css">
</head>
<body>



  <div class="navigation-arrows">
    <a href="Connection.html" class="arrow left-arrow" aria-label="Page pr√©c√©dente">
        <svg viewBox="0 0 24 24">
            <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"/>
        </svg>
    </a>
    <a href="index.html" class="arrow home-button" aria-label="Page d'accueil">
        <svg viewBox="0 0 24 24">
            <path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>
    </a>
    <button class="arrow refresh-button" aria-label="Actualiser la page" onclick="location.reload();">
        <svg viewBox="0 0 24 24">
            <path fill="currentColor" d="M17.65 6.35A7.9 7.9 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08v-4h6v4H17.65zM12 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
        </svg>
    </button>
</div>

<style>
    /* Styles pour les fl√®ches de navigation */
    .navigation-arrows {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1.5rem;
        width: 150px; /* Ajustez la largeur pour espacer les boutons */
        margin-left: auto;
        margin-right: auto;
    }

    .arrow {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 40px;
        height: 40px;
        background-color: #f0f0f0;
        border-radius: 50%;
        text-decoration: none;
        color: #007bff; /* Couleur primaire */
        transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
        cursor: pointer;
        border: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .arrow:hover {
        background-color: #007bff; /* Couleur primaire au survol */
        color: white;
        transform: scale(1.05);
    }

    .arrow svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
    }

    .refresh-button:hover {
        transform: rotate(180deg);
    }

</style>

  <div class="container">
    <h1>üîç Suivi de colis</h1>
    <p id="location-status">üìç Localisation en cours...</p>
    
    <div class="logo-container">
      <img src="img/ChatGPT Image 30 avr. 2025, 20_34_02.png" alt="Logo Livreur 2.0" class="logo-img animate__animated animate__fadeInDown">
  </div>
  

    <form id="client-form" class="card">
      <h2>Rechercher un colis</h2>
      
      <div class="form-group">
        <label for="nom">Nom</label>
        <input type="text" id="nom" required autocomplete="family-name">
      </div>
      
      <div class="form-group">
        <label for="prenom">Pr√©nom</label>
        <input type="text" id="prenom" required autocomplete="given-name">
      </div>
      
      <div class="form-group">
        <label for="numero">T√©l√©phone</label>
        <input type="tel" id="numero" required autocomplete="tel">
      </div>
      
      <div class="form-group">
        <label for="code">Code colis</label>
        <input type="text" id="code" required pattern="[A-Z0-9]{8,20}">
      </div>
      
      <button type="submit" class="btn-primary">
        <span class="btn-text">üì¶ Rechercher</span>
        <span class="btn-loader" hidden></span>
      </button>
    </form>
    
    <div id="messages">
      <p id="error-msg" class="message-error" hidden></p>
    </div>
    
    <div id="colis-info" class="card" hidden>
      <div id="colis-content"></div>
    </div>
  </div>


  <button class="modern-link-button" onclick="window.location.href='suivi.html'">
    üëÄSuivre ma commande
  </button>
  

  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Configuration
        const config = {
            apiEndpoint: '/.netlify/functions/client-handler'
        };

        // √âl√©ments DOM
        const elements = {
            form: document.getElementById('client-form'),
            nom: document.getElementById('nom'),
            prenom: document.getElementById('prenom'),
            numero: document.getElementById('numero'),
            code: document.getElementById('code'),
            submitBtn: document.querySelector('#client-form button[type="submit"]'),
            btnText: document.querySelector('.btn-text'),
            btnLoader: document.querySelector('.btn-loader'),
            locationStatus: document.getElementById('location-status'),
            colisInfo: document.getElementById('colis-info'),
            colisContent: document.getElementById('colis-content'),
            errorMsg: document.getElementById('error-msg')
        };

        let userLocation = null;
        let locationObtained = false; // Variable pour suivre si la localisation a √©t√© obtenue

        const getLocation = () => {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    elements.locationStatus.textContent = '‚ùå G√©olocalisation non support√©e';
                    reject(new Error('G√©olocalisation non support√©e'));
                    return;
                }

                elements.locationStatus.textContent = 'üîÑ Localisation en cours...';
                elements.locationStatus.classList.add('animate__animated', 'animate__flash'); // Ajout des classes d'animation

                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            latitude: position.coords.latitude.toFixed(6),
                            longitude: position.coords.longitude.toFixed(6)
                        };
                        locationObtained = true; // Marquer la localisation comme obtenue
                        elements.locationStatus.textContent = 'üìç Localisation activ√©e';
                        elements.locationStatus.classList.remove('animate__animated', 'animate__flash'); // Suppression des classes
                        resolve(userLocation);
                    },
                    error => {
                        let message = 'Erreur de localisation';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                message = '‚ùå Permission refus√©e';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message = '‚ùå Service indisponible';
                                break;
                            case error.TIMEOUT:
                                message = '‚ö†Ô∏è Temps √©coul√©';
                                break;
                        }
                        elements.locationStatus.textContent = message;
                        elements.locationStatus.classList.remove('animate__animated', 'animate__flash'); // Suppression des classes
                        elements.locationStatus.classList.add('error', 'animate__animated', 'animate__shakeX'); // Animation d'erreur
                        reject(new Error(message));
                        setTimeout(() => {
                            elements.locationStatus.classList.remove('animate__shakeX');
                            elements.locationStatus.classList.remove('error');
                        }, 1000);
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            });
        };

        const showError = (message) => {
            elements.errorMsg.textContent = message;
            elements.errorMsg.hidden = false;
            elements.colisInfo.hidden = true;
        }; 
        // Obtenir la localisation au chargement de la page
        getLocation();

        // Soumission du formulaire
        elements.form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // V√©rifier si la localisation a √©t√© obtenue
            if (!locationObtained || !userLocation) {
                showError('La localisation est n√©cessaire pour cette action. Veuillez patienter pendant que nous obtenons votre position.');
                return; // Emp√™cher la soumission si la localisation n'est pas pr√™te
            }

            // Reset UI
            elements.errorMsg.hidden = true;
            elements.colisInfo.hidden = true;
            elements.btnText.hidden = true;
            elements.btnLoader.hidden = false;
            elements.submitBtn.disabled = true;
            elements.btnLoader.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Ajout d'un spinner Font Awesome

            try {
                // Validation du code colis
                if (!elements.code.value.match(/^[A-Z0-9]{8,20}$/)) {
                    throw new Error('Code colis invalide');
                }

                // Envoi des donn√©es avec la localisation
                const response = await fetch(config.apiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nom: elements.nom.value.trim(),
                        prenom: elements.prenom.value.trim(),
                        numero: elements.numero.value.trim(),
                        code: elements.code.value.trim(),
                        location: userLocation
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Erreur de recherche');
                }

                if (!data.colis) {
                    throw new Error('Aucune information de colis disponible');
                }

                // Affichage des r√©sultats
                displayColisInfo(data.colis);

            } catch (error) {
                showError(error.message);
            } finally {
                elements.btnText.hidden = false;
                elements.btnLoader.hidden = true;
                elements.btnLoader.innerHTML = ''; // Nettoyer le loader
                elements.submitBtn.disabled = false;
            }
        });
  

// üîç Affiche les d√©tails d‚Äôun colis s√©lectionn√©
function displayColisInfo(colis) {
  const statusClass = `status-${(colis.status || 'enregistr√©')}`.toLowerCase();

  // üß± Injection dynamique du contenu HTML du colis
  elements.colisContent.innerHTML = `
    <div class="colis-header">
      <h2>
        Colis #${colis.colisID}
        <span class="status-badge ${statusClass}">
          ${(colis.status || 'enregistr√©').toUpperCase()}
        </span>
      </h2>
      <p class="colis-meta">
        <strong>Cr√©√© le :</strong> ${new Date(colis.createdAt).toLocaleString('fr-FR')}
      </p>
    </div>

    <div class="colis-grid">
      <div class="colis-section">
        <h3>Exp√©diteur</h3>
        <p>${escapeHTML(colis.sender)}</p>
        <p>${escapeHTML(colis.phone1)}</p>
      </div>

      <div class="colis-section">
        <h3>Destinataire</h3>
        <p>${escapeHTML(colis.recipient)}</p>
        <p>${escapeHTML(colis.phone)}</p>
        <p>${escapeHTML(colis.address)}</p>
      </div>

      <div class="colis-section">
        <h3>D√©tails</h3>
        <p><strong>Type :</strong> ${escapeHTML(colis.type)}</p>
        <p><strong>Description :</strong> ${escapeHTML(colis.details || 'Non sp√©cifi√©')}</p>
      </div>
    </div>

    ${colis.photos?.length > 0 ? `
      <div class="colis-photos">
        <h3>Photos</h3>
        <div class="photos-grid">
          ${colis.photos.slice(0, 2).map(photo => `
            <img src="${photo.data}" alt="Photo du colis" class="photo-preview" />
          `).join('')}
        </div>
      </div>
    ` : ''}

    ${colis.history?.length > 0 ? `
      <div class="colis-timeline">
        <h3>Historique</h3>
        <div class="timeline">
          ${colis.history.map(item => `
            <div class="timeline-item">
              <div class="timeline-date">
                ${new Date(item.date).toLocaleString('fr-FR')}
              </div>
              <div class="timeline-content">
                <strong>${item.status.toUpperCase()}</strong>
                ${item.location ? `<p>üìç ${item.location.latitude}, ${item.location.longitude}</p>` : ''}
                ${item.notes ? `<p>${escapeHTML(item.notes)}</p>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    ` : ''}

    <div class="action-buttons">
      <button id="btn-recevoir" class="btn receive-btn">‚úÖ Recevoir</button>
      <button id="btn-decliner" class="btn decline-btn">‚ùå D√©cliner</button>
    </div>
  `;

 // üì¶ Affiche la section d'informations colis
 elements.colisInfo.hidden = false;

const recevoirButton = document.getElementById('btn-recevoir');
let recevoirClicked = false;

// ‚úÖ √âcouteur : clic sur "Recevoir"
recevoirButton.addEventListener('click', async () => {
  if (recevoirClicked) {
    return; // Emp√™che de cliquer √† nouveau
  }
  recevoirClicked = true;
  recevoirButton.disabled = true; // D√©sactive le bouton apr√®s le clic
  recevoirButton.classList.add('disabled'); // Ajoute une classe pour le style d√©sactiv√©

  const codeID = colis.colisID;

  try {
    showSpinner();

    const response = await fetch('/.netlify/functions/recevoir', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ codeID }),
    });

    const data = await response.json();
    hideSpinner();

    if (response.ok) {
      showCheckmark();
      showToast(data.message, 'success');
      // D√©sactiver d√©finitivement le bouton ou le masquer apr√®s succ√®s
      recevoirButton.disabled = true;
      recevoirButton.classList.add('disabled');
    } else {
      showAlert(data.error || 'Erreur lors de l‚Äôenregistrement.', 'error');
      // R√©activer le bouton en cas d'erreur pour permettre une nouvelle tentative
      recevoirButton.disabled = false;
      recevoirButton.classList.remove('disabled');
      recevoirClicked = false;
    }
  } catch (err) {
    console.error(err);
    hideSpinner();
    showAlert('Erreur de connexion au serveur.', 'error');
    // R√©activer le bouton en cas d'erreur de connexion
    recevoirButton.disabled = false;
    recevoirButton.classList.remove('disabled');
    recevoirClicked = false;
  }
});

// ‚ùå √âcouteur : clic sur "D√©cliner"
document.getElementById('btn-decliner').addEventListener('click', async () => {
  const codeID = colis.colisID;

  const confirmed = await showConfirm("√ätes-vous s√ªr de vouloir refuser ce colis ?");
  if (!confirmed) return;

  try {
    showSpinner(); // Affichage du spinner lors de l'attente de la r√©ponse du serveur

    const response = await fetch('/.netlify/functions/decliner', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ codeID }),
    });

    const result = await response.json();
    hideSpinner(); // Masquage du spinner apr√®s la r√©ponse

    // Si la r√©ponse est correcte
    if (response.ok) {
      // Affichage de l'alerte apr√®s avoir confirm√© le refus
      showAlert("Le colis a √©t√© supprim√© de notre serveur. Veuillez contacter votre exp√©diteur pour r√©exp√©dier le colis.", 'success');
      elements.colisInfo.hidden = true; // Masquage des informations du colis
    } else {
      showAlert(result.error || 'Erreur lors du traitement.', 'error'); // Affichage d'un message d'erreur
    }
  } catch (error) {
    console.error(error);
    hideSpinner(); // Masquage du spinner en cas d'erreur
    showAlert('Erreur de connexion au serveur.', 'error'); // Affichage d'une erreur de connexion
  }
});
}

// Fonctions utilitaires
function showError(message) {
  elements.errorMsg.textContent = message;
  elements.errorMsg.hidden = false;
  elements.colisInfo.hidden = true;
}

if (response.ok) {
  showCheckmark();
  showToast(data.message, 'success');
  // ou showAlert(...) si besoin
}




      
      function escapeHTML(str) {
        if (!str) return '';
        return str.toString()
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }
      
      // Initialisation
      getLocation().catch(error => {
        console.error('Erreur de localisation:', error);
      });
    });
  </script>


<div id="custom-alert" class="custom-alert hidden">
    <div class="alert-content">
      <img id="alert-icon" src="" alt="icon" class="alert-icon">
      <p id="alert-message">Message</p>
      <button id="alert-close">OK</button>
    </div>
  </div>
  
  <div id="spinner-overlay" class="spinner-overlay hidden">
    <div class="spinner"></div>
  </div>



  <div id="custom-confirm" class="custom-alert hidden">
    <div class="alert-content">
      <img src="https://cdn-icons-png.flaticon.com/512/190/190406.png" alt="question" class="alert-icon" />
      <p id="confirm-message">√ätes-vous s√ªr de vouloir refuser ce colis ?</p>
      <button id="confirm-yes">Oui</button>
      <button id="confirm-no">Non</button>
    </div>
  </div>
  


  <div id="toast" class="toast hidden">
    <img id="toast-icon" src="" alt="icon" class="toast-icon" />
    <span id="toast-message">Message</span>
  </div>




  <div id="check-animation" class="checkmark-wrapper hidden">
    <svg class="checkmark" viewBox="0 0 52 52">
      <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />
      <path class="checkmark-check" fill="none" d="M14 27l7 7 16-16" />
    </svg>
  </div>
  


  <script>
    function showCheckmark(duration = 5000) {
  const wrapper = document.getElementById('check-animation');
  wrapper.classList.remove('hidden');

  setTimeout(() => {
    wrapper.classList.add('hidden');
  }, duration);
}

  </script>
  

  <script>
function showToast(message, type = 'info', duration = 3000) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const toastIcon = document.getElementById('toast-icon');

    const icons = {
        info: 'https://cdn-icons-png.flaticon.com/512/3564/3564509.png',
        success: 'https://cdn-icons-png.flaticon.com/512/845/845646.png',
        error: 'https://cdn-icons-png.flaticon.com/512/463/463612.png',
    };

    toastMessage.textContent = message;
    toastIcon.src = icons[type] || icons.info;

    toast.classList.add('show', 'animate__animated', 'animate__fadeIn'); // Ajouter les classes animate.css

    setTimeout(() => {
        toast.classList.remove('show', 'animate__fadeIn');
        toast.classList.add('animate__fadeOut'); // Animation de disparition
        setTimeout(() => {
            toast.classList.remove('animate__fadeOut');
        }, 500); // Dur√©e de l'animation de disparition
    }, duration);
}


  </script>


  <script>
    function showConfirm(message) {
  return new Promise((resolve) => {
    const confirmBox = document.getElementById('custom-confirm');
    const confirmMessage = document.getElementById('confirm-message');

    confirmMessage.textContent = message;
    confirmBox.classList.remove('hidden');

    document.getElementById('confirm-yes').onclick = () => {
      confirmBox.classList.add('hidden');
      resolve(true);
    };

    document.getElementById('confirm-no').onclick = () => {
      confirmBox.classList.add('hidden');
      resolve(false);
    };
  });
}

  </script>
  


  <script>
    function showAlert(message, type = 'info') {
  const alertBox = document.getElementById('custom-alert');
  const alertMessage = document.getElementById('alert-message');
  const alertIcon = document.getElementById('alert-icon');

  alertMessage.textContent = message;

  const icons = {
    info: 'https://cdn-icons-png.flaticon.com/512/3564/3564509.png',
    success: 'https://cdn-icons-png.flaticon.com/512/845/845646.png',
    error: 'https://cdn-icons-png.flaticon.com/512/463/463612.png',
  };

  alertIcon.src = icons[type] || icons.info;

  alertBox.classList.remove('hidden');

  document.getElementById('alert-close').onclick = () => {
    alertBox.classList.add('hidden');
  };
}

function showSpinner() {
  document.getElementById('spinner-overlay').classList.remove('hidden');
}

function hideSpinner() {
  document.getElementById('spinner-overlay').classList.add('hidden');
}

  </script>



<div class="navigation-arrows">
  <a href="Connection.html" class="arrow left-arrow" aria-label="Page pr√©c√©dente">
    <svg viewBox="0 0 24 24">
      <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"/>
    </svg>
  </a>
  <button class="arrow refresh-button" aria-label="Actualiser la page" onclick="location.reload();">
    <svg viewBox="0 0 24 24">
      <path fill="currentColor" d="M17.65 6.35A7.9 7.9 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08v-4h6v4H17.65zM12 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
    </svg>
  </button>
</div>

</body>
</html>