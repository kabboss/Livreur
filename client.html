<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Suivi de colis en temps r√©el">
  <title>Suivi Colis | Plateforme de livraison</title>
 
  <link rel="stylesheet" href="client.css">
</head>
<body>
  <div class="container">
    <h1>üîç Suivi de colis</h1>
    <p id="location-status">üìç Localisation en cours...</p>
    
    <form id="client-form" class="card">
      <h2>Rechercher un colis</h2>
      
      <div class="form-group">
        <label for="nom">Nom</label>
        <input type="text" id="nom" required autocomplete="family-name">
      </div>
      
      <div class="form-group">
        <label for="prenom">Pr√©nom</label>
        <input type="text" id="prenom" required autocomplete="given-name">
      </div>
      
      <div class="form-group">
        <label for="numero">T√©l√©phone</label>
        <input type="tel" id="numero" required autocomplete="tel">
      </div>
      
      <div class="form-group">
        <label for="code">Code colis</label>
        <input type="text" id="code" required pattern="[A-Z0-9]{8,20}">
      </div>
      
      <button type="submit" class="btn-primary">
        <span class="btn-text">üì¶ Rechercher</span>
        <span class="btn-loader" hidden></span>
      </button>
    </form>
    
    <div id="messages">
      <p id="error-msg" class="message-error" hidden></p>
    </div>
    
    <div id="colis-info" class="card" hidden>
      <div id="colis-content"></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Configuration
      const config = {
        apiEndpoint: '/.netlify/functions/client-handler'
      };
      
      // √âl√©ments DOM
      const elements = {
        form: document.getElementById('client-form'),
        nom: document.getElementById('nom'),
        prenom: document.getElementById('prenom'),
        numero: document.getElementById('numero'),
        code: document.getElementById('code'),
        submitBtn: document.querySelector('#client-form button[type="submit"]'),
        btnText: document.querySelector('.btn-text'),
        btnLoader: document.querySelector('.btn-loader'),
        locationStatus: document.getElementById('location-status'),
        colisInfo: document.getElementById('colis-info'),
        colisContent: document.getElementById('colis-content'),
        errorMsg: document.getElementById('error-msg')
      };
      
      let userLocation = null;
      
      // Gestion de la g√©olocalisation
      const getLocation = () => {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            elements.locationStatus.textContent = '‚ùå G√©olocalisation non support√©e';
            reject(new Error('G√©olocalisation non support√©e'));
            return;
          }
          
          elements.locationStatus.textContent = 'üîÑ Localisation en cours...';
          
          navigator.geolocation.getCurrentPosition(
            position => {
              userLocation = {
                latitude: position.coords.latitude.toFixed(6),
                longitude: position.coords.longitude.toFixed(6)
              };
              elements.locationStatus.textContent = 'üìç Localisation activ√©e';
              resolve(userLocation);
            },
            error => {
              let message = 'Erreur de localisation';
              switch(error.code) {
                case error.PERMISSION_DENIED:
                  message = '‚ùå Permission refus√©e';
                  break;
                case error.POSITION_UNAVAILABLE:
                  message = '‚ùå Service indisponible';
                  break;
                case error.TIMEOUT:
                  message = '‚ö†Ô∏è Temps √©coul√©';
                  break;
              }
              elements.locationStatus.textContent = message;
              reject(new Error(message));
            },
            {
              enableHighAccuracy: true,
              timeout: 10000
            }
          );
        });
      };
      
      // Soumission du formulaire
      elements.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Reset UI
        elements.errorMsg.hidden = true;
        elements.colisInfo.hidden = true;
        elements.btnText.hidden = true;
        elements.btnLoader.hidden = false;
        elements.submitBtn.disabled = true;
        
        try {
          // Validation
          if (!elements.code.value.match(/^[A-Z0-9]{8,20}$/)) {
            throw new Error('Code colis invalide');
          }
          
          // Envoi des donn√©es
          const response = await fetch(config.apiEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              nom: elements.nom.value.trim(),
              prenom: elements.prenom.value.trim(),
              numero: elements.numero.value.trim(),
              code: elements.code.value.trim(),
              location: userLocation
            })
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.message || 'Erreur de recherche');
          }
          
          if (!data.colis) {
            throw new Error('Aucune information de colis disponible');
          }
          
          // Affichage des r√©sultats
          displayColisInfo(data.colis);
        } catch (error) {
          showError(error.message);
        } finally {
          elements.btnText.hidden = false;
          elements.btnLoader.hidden = true;
          elements.submitBtn.disabled = false;
        }
      });
// üîç Affiche les d√©tails d‚Äôun colis s√©lectionn√©
function displayColisInfo(colis) {
  const statusClass = `status-${(colis.status || 'enregistr√©')}`.toLowerCase();

  // üß± Injection dynamique du contenu HTML du colis
  elements.colisContent.innerHTML = `
    <div class="colis-header">
      <h2>
        Colis #${colis.colisID}
        <span class="status-badge ${statusClass}">
          ${(colis.status || 'enregistr√©').toUpperCase()}
        </span>
      </h2>
      <p class="colis-meta">
        <strong>Cr√©√© le :</strong> ${new Date(colis.createdAt).toLocaleString('fr-FR')}
      </p>
    </div>

    <div class="colis-grid">
      <div class="colis-section">
        <h3>Exp√©diteur</h3>
        <p>${escapeHTML(colis.sender)}</p>
        <p>${escapeHTML(colis.phone1)}</p>
      </div>

      <div class="colis-section">
        <h3>Destinataire</h3>
        <p>${escapeHTML(colis.recipient)}</p>
        <p>${escapeHTML(colis.phone)}</p>
        <p>${escapeHTML(colis.address)}</p>
      </div>

      <div class="colis-section">
        <h3>D√©tails</h3>
        <p><strong>Type :</strong> ${escapeHTML(colis.type)}</p>
        <p><strong>Description :</strong> ${escapeHTML(colis.details || 'Non sp√©cifi√©')}</p>
      </div>
    </div>

    ${colis.photos?.length > 0 ? `
      <div class="colis-photos">
        <h3>Photos</h3>
        <div class="photos-grid">
          ${colis.photos.slice(0, 2).map(photo => `
            <img src="${photo.data}" alt="Photo du colis" class="photo-preview" />
          `).join('')}
        </div>
      </div>
    ` : ''}

    ${colis.history?.length > 0 ? `
      <div class="colis-timeline">
        <h3>Historique</h3>
        <div class="timeline">
          ${colis.history.map(item => `
            <div class="timeline-item">
              <div class="timeline-date">
                ${new Date(item.date).toLocaleString('fr-FR')}
              </div>
              <div class="timeline-content">
                <strong>${item.status.toUpperCase()}</strong>
                ${item.location ? `<p>üìç ${item.location.latitude}, ${item.location.longitude}</p>` : ''}
                ${item.notes ? `<p>${escapeHTML(item.notes)}</p>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    ` : ''}

    <div class="action-buttons">
      <button id="btn-recevoir" class="btn receive-btn">‚úÖ Recevoir</button>
      <button id="btn-decliner" class="btn decline-btn">‚ùå D√©cliner</button>
    </div>
  `;

  // üì¶ Affiche la section d'informations colis
  elements.colisInfo.hidden = false;

  // ‚úÖ √âcouteur : clic sur "Recevoir"
  document.getElementById('btn-recevoir').addEventListener('click', async () => {
    const codeID = colis.colisID;

    try {
      showSpinner();

      const response = await fetch('/.netlify/functions/recevoir', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ codeID }),
      });

      const data = await response.json();
      hideSpinner();

      if (response.ok) {
        showCheckmark();
        showToast(data.message, 'success');
      } else {
        showAlert(data.error || 'Erreur lors de l‚Äôenregistrement.', 'error');
      }
    } catch (err) {
      console.error(err);
      hideSpinner();
      showAlert('Erreur de connexion au serveur.', 'error');
    }
  });

  // ‚ùå √âcouteur : clic sur "D√©cliner"
  document.getElementById('btn-decliner').addEventListener('click', async () => {
    const codeID = colis.colisID;

    const confirmed = await showConfirm("√ätes-vous s√ªr de vouloir refuser ce colis ?");
    if (!confirmed) return;

    try {
      showSpinner();

      const response = await fetch('/.netlify/functions/decliner', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ codeID }),
      });

      const result = await response.json();
      hideSpinner();

      if (response.ok) {
        showToast(result.message, 'success');
        elements.colisInfo.hidden = true;
      } else {
        showAlert(result.error || 'Erreur lors du traitement.', 'error');
      }
    } catch (error) {
      console.error(error);
      hideSpinner();
      showAlert('Erreur de connexion au serveur.', 'error');
    }
  });
}

// Fonctions utilitaires
function showError(message) {
  elements.errorMsg.textContent = message;
  elements.errorMsg.hidden = false;
  elements.colisInfo.hidden = true;
}

if (response.ok) {
  showCheckmark();
  showToast(data.message, 'success');
  // ou showAlert(...) si besoin
}




      
      function escapeHTML(str) {
        if (!str) return '';
        return str.toString()
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }
      
      // Initialisation
      getLocation().catch(error => {
        console.error('Erreur de localisation:', error);
      });
    });
  </script>


<div id="custom-alert" class="custom-alert hidden">
    <div class="alert-content">
      <img id="alert-icon" src="" alt="icon" class="alert-icon">
      <p id="alert-message">Message</p>
      <button id="alert-close">OK</button>
    </div>
  </div>
  
  <div id="spinner-overlay" class="spinner-overlay hidden">
    <div class="spinner"></div>
  </div>



  <div id="custom-confirm" class="custom-alert hidden">
    <div class="alert-content">
      <img src="https://cdn-icons-png.flaticon.com/512/190/190406.png" alt="question" class="alert-icon" />
      <p id="confirm-message">√ätes-vous s√ªr de vouloir refuser ce colis ?</p>
      <button id="confirm-yes">Oui</button>
      <button id="confirm-no">Non</button>
    </div>
  </div>
  


  <div id="toast" class="toast hidden">
    <img id="toast-icon" src="" alt="icon" class="toast-icon" />
    <span id="toast-message">Message</span>
  </div>




  <div id="check-animation" class="checkmark-wrapper hidden">
    <svg class="checkmark" viewBox="0 0 52 52">
      <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />
      <path class="checkmark-check" fill="none" d="M14 27l7 7 16-16" />
    </svg>
  </div>
  


  <script>
    function showCheckmark(duration = 1500) {
  const wrapper = document.getElementById('check-animation');
  wrapper.classList.remove('hidden');

  setTimeout(() => {
    wrapper.classList.add('hidden');
  }, duration);
}

  </script>
  

  <script>
    function showToast(message, type = 'info', duration = 3000) {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toast-message');
  const toastIcon = document.getElementById('toast-icon');

  const icons = {
    info: 'https://cdn-icons-png.flaticon.com/512/3564/3564509.png',
    success: 'https://cdn-icons-png.flaticon.com/512/845/845646.png',
    error: 'https://cdn-icons-png.flaticon.com/512/463/463612.png',
  };

  toastMessage.textContent = message;
  toastIcon.src = icons[type] || icons.info;

  toast.classList.add('show');

  setTimeout(() => {
    toast.classList.remove('show');
  }, duration);
}

  </script>


  <script>
    function showConfirm(message) {
  return new Promise((resolve) => {
    const confirmBox = document.getElementById('custom-confirm');
    const confirmMessage = document.getElementById('confirm-message');

    confirmMessage.textContent = message;
    confirmBox.classList.remove('hidden');

    document.getElementById('confirm-yes').onclick = () => {
      confirmBox.classList.add('hidden');
      resolve(true);
    };

    document.getElementById('confirm-no').onclick = () => {
      confirmBox.classList.add('hidden');
      resolve(false);
    };
  });
}

  </script>
  


  <script>
    function showAlert(message, type = 'info') {
  const alertBox = document.getElementById('custom-alert');
  const alertMessage = document.getElementById('alert-message');
  const alertIcon = document.getElementById('alert-icon');

  alertMessage.textContent = message;

  const icons = {
    info: 'https://cdn-icons-png.flaticon.com/512/3564/3564509.png',
    success: 'https://cdn-icons-png.flaticon.com/512/845/845646.png',
    error: 'https://cdn-icons-png.flaticon.com/512/463/463612.png',
  };

  alertIcon.src = icons[type] || icons.info;

  alertBox.classList.remove('hidden');

  document.getElementById('alert-close').onclick = () => {
    alertBox.classList.add('hidden');
  };
}

function showSpinner() {
  document.getElementById('spinner-overlay').classList.remove('hidden');
}

function hideSpinner() {
  document.getElementById('spinner-overlay').classList.add('hidden');
}

  </script>


</body>
</html>