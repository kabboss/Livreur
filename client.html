<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Client - Suivi de colis</title>
  <link rel="stylesheet" href="client.css" />

</head>
<body>

  <h1>üîç Suivre mon colis</h1>
  <p id="location-status">üìç R√©cup√©ration de la localisation...</p>

  <form id="client-form">
    <label>Nom</label>
    <input type="text" id="nom" required>
    
    <label>Pr√©nom</label>
    <input type="text" id="prenom" required>

    <label>Num√©ro de t√©l√©phone</label>
    <input type="tel" id="numero" required>

    <label>Code d'exp√©dition</label>
    <input type="text" id="code" required>

    <button type="submit">üì¶ Voir mon colis</button>
  </form>

  <div id="colis-info"></div>
  <p id="msg" class="error"></p>

  <script>
    let userLocation = null;

    // R√©cup√©ration de la position
    window.onload = () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            userLocation = {
              latitude: pos.coords.latitude,
              longitude: pos.coords.longitude
            };
            document.getElementById("location-status").textContent = "üìç Position r√©cup√©r√©e.";
          },
          () => {
            document.getElementById("location-status").textContent = "‚ùå Position non autoris√©e.";
          }
        );
      }
    };

    // Soumission du formulaire
    document.getElementById("client-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const nom = document.getElementById("nom").value;
      const prenom = document.getElementById("prenom").value;
      const numero = document.getElementById("numero").value;
      const code = document.getElementById("code").value;

      // Envoi vers le backend
      try {
        const res = await fetch("/.netlify/functions/client-handler", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            nom, prenom, numero, code,
            location: userLocation
          })
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.message || "Erreur de recherche");

        const colis = data.colis;

        document.getElementById("msg").textContent = "";
        document.getElementById("colis-info").style.display = "block";
        document.getElementById("colis-info").innerHTML = `
          <h3>üì¶ D√©tails du colis</h3>
          <p><strong>Exp√©diteur :</strong> ${colis.sender}</p>
          <p><strong>Destinataire :</strong> ${colis.recipient}</p>
          <p><strong>Adresse de livraison :</strong> ${colis.address}</p>
          <p><strong>Type :</strong> ${colis.type}</p>
          <p><strong>D√©tails :</strong> ${colis.details}</p>
        `;
      } catch (err) {
        document.getElementById("msg").textContent = "‚ùå " + err.message;
        document.getElementById("colis-info").style.display = "none";
      }
    });
  </script>
</body>
</html>
