<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Interface livreur pour la gestion des colis">
  <!-- Font Awesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <title>üì¶ Interface Livreur | Gestion des Colis</title>
  <link rel="stylesheet" href="livreur.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
<br>
<br>

<div class="navigation-arrows">
  <a href="Connection.html" class="arrow left-arrow" aria-label="Page pr√©c√©dente">
      <svg viewBox="0 0 24 24">
          <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"/>
      </svg>
  </a>
  <a href="index.html" class="arrow home-button" aria-label="Page d'accueil">
      <svg viewBox="0 0 24 24">
          <path fill="currentColor" d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
      </svg>
  </a>
  <button class="arrow refresh-button" aria-label="Actualiser la page" onclick="location.reload();">
      <svg viewBox="0 0 24 24">
          <path fill="currentColor" d="M17.65 6.35A7.9 7.9 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08v-4h6v4H17.65zM12 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
      </svg>
  </button>
</div>

<style>
  /* Styles pour les fl√®ches de navigation */
  .navigation-arrows {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1.5rem;
      width: 150px; /* Ajustez la largeur pour espacer les boutons */
      margin-left: auto;
      margin-right: auto;
  }

  .arrow {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
      background-color: #f0f0f0;
      border-radius: 50%;
      text-decoration: none;
      color: #007bff; /* Couleur primaire */
      transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
      cursor: pointer;
      border: none;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .arrow:hover {
      background-color: #007bff; /* Couleur primaire au survol */
      color: white;
      transform: scale(1.05);
  }

  .arrow svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
  }

  .refresh-button:hover {
      transform: rotate(180deg);
  }

</style>

  <div class="container">
    <header>
      <h1>Interface Livreur</h1>
      <p id="location-status" aria-live="polite">üìç Localisation en cours...</p>
    </header>

  
<script>

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast-bar ${type}`;
  toast.innerHTML = `
    <span>${message}</span>
    <span class="close-btn">&times;</span>
  `;

  // Ajout du toast √† la page
  document.body.appendChild(toast);

  // Fermeture manuelle
  toast.querySelector('.close-btn').onclick = () => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 500);
  };

  // Animation d‚Äôapparition
  setTimeout(() => toast.classList.add('show'), 50);

  // Fermeture automatique apr√®s 4 secondes
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 500);
  }, 4000);
}
  


</script>


<main>
      <div id="colis-list" class="colis-container"></div>
    </main>
  </div>

  <!-- Modale pour image agrandie -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <img id="modalImage" alt="Image agrandie du colis">
    </div>
    <span id="modalClose" class="modal-close" aria-label="Fermer la modale">&times;</span>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const locationStatus = document.getElementById('location-status');
      const colisList = document.getElementById('colis-list');
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      const modalClose = document.getElementById('modalClose');
      let livreurLocation = null;

      // Gestion de la modale d'image
      modalClose.addEventListener('click', () => {
        modal.classList.remove('active');
      });

      // Obtenir la position du livreur
      const getLocation = () => {
        if ('geolocation' in navigator) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              livreurLocation = {
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude,
              };
              locationStatus.innerHTML = `üìç <a href="https://www.google.com/maps?q=${livreurLocation.latitude},${livreurLocation.longitude}" target="_blank" style="color: blue; text-decoration: underline;">Voir ma position sur Google Maps</a>`;
              locationStatus.classList.add('success');
              fetchColis();
            },
            err => {
              locationStatus.textContent = '‚ö†Ô∏è Impossible d\'obtenir la localisation (activez-la pour une meilleure exp√©rience)';
              locationStatus.classList.add('error');
              fetchColis();
            },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        } else {
          locationStatus.textContent = '‚ö†Ô∏è G√©olocalisation non support√©e par votre navigateur';
          locationStatus.classList.add('error');
          fetchColis();
        }
      };

      // R√©cup√©rer la liste des colis depuis l'API
      async function fetchColis() {
        try {
          colisList.innerHTML = '<div class="loading">Chargement des colis...</div>';

          const res = await fetch('/.netlify/functions/getLivraisons');
          const data = await res.json();

          if (res.ok) {
            displayColis(data);
          } else {
            colisList.innerHTML = `<div class="error-message">Erreur: ${data.error || 'Impossible de charger les colis'}</div>`;
          }
        } catch (e) {
          console.error('Erreur fetch:', e);
          colisList.innerHTML = '<div class="error-message">Erreur de connexion au serveur</div>';
        }
      }



// Fonction de calcul de distance ultra-pr√©cise (Algorithme de Vincenty)
function calculerDistance(lat1, lon1, lat2, lon2) {
    // Constantes de l'ellipso√Øde WGS-84
    const a = 6378137.0; // demi-grand axe en m√®tres
    const b = 6356752.314245; // demi-petit axe en m√®tres
    const f = 1 / 298.257223563; // aplatissement

    // Conversion des degr√©s en radians
    const œÜ1 = lat1 * Math.PI / 180;
    const œÜ2 = lat2 * Math.PI / 180;
    const Œª1 = lon1 * Math.PI / 180;
    const Œª2 = lon2 * Math.PI / 180;

    // Diff√©rences de longitude
    const L = Œª2 - Œª1;

    // Param√®tres initiaux
    const U1 = Math.atan((1 - f) * Math.tan(œÜ1));
    const U2 = Math.atan((1 - f) * Math.tan(œÜ2));
    const sinU1 = Math.sin(U1), cosU1 = Math.cos(U1);
    const sinU2 = Math.sin(U2), cosU2 = Math.cos(U2);

    let Œª = L, Œª π, iterLimit = 100;
    let cosSqŒ±, sinœÉ, cosœÉ, cos2œÉM, œÉ, sinŒª, cosŒª;

    do {
        sinŒª = Math.sin(Œª);
        cosŒª = Math.cos(Œª);
        sinœÉ = Math.sqrt((cosU2 * sinŒª) * (cosU2 * sinŒª) +
                        (cosU1 * sinU2 - sinU1 * cosU2 * cosŒª) *
                        (cosU1 * sinU2 - sinU1 * cosU2 * cosŒª));

        if (sinœÉ === 0) return 0; // points co√Øncidents

        cosœÉ = sinU1 * sinU2 + cosU1 * cosU2 * cosŒª;
        œÉ = Math.atan2(sinœÉ, cosœÉ);
        const sinŒ± = cosU1 * cosU2 * sinŒª / sinœÉ;
        cosSqŒ± = 1 - sinŒ± * sinŒ±;
        cos2œÉM = cosœÉ - 2 * sinU1 * sinU2 / cosSqŒ±;

        if (isNaN(cos2œÉM)) cos2œÉM = 0; // ligne √©quatoriale
        const C = f / 16 * cosSqŒ± * (4 + f * (4 - 3 * cosSqŒ±));
        Œª π = Œª;
        Œª = L + (1 - C) * f * sinŒ± *
                (œÉ + C * sinœÉ * (cos2œÉM + C * cosœÉ * (-1 + 2 * cos2œÉM * cos2œÉM)));
    } while (Math.abs(Œª - Œª π) > 1e-12 && --iterLimit > 0);

    if (iterLimit === 0) {
        return distanceHaversine(lat1, lon1, lat2, lon2);
    }

    const uSq = cosSqŒ± * (a * a - b * b) / (b * b);
    const A = 1 + uSq / 16384 * (4096 + uSq * (-768 + uSq * (320 - 175 * uSq)));
    const B = uSq / 1024 * (256 + uSq * (-128 + uSq * (74 - 47 * uSq)));
    const ŒîœÉ = B * sinœÉ * (cos2œÉM + B / 4 *
                        (cosœÉ * (-1 + 2 * cos2œÉM * cos2œÉM) -
                         B / 6 * cos2œÉM * (-3 + 4 * sinœÉ * sinœÉ) *
                         (-3 + 4 * cos2œÉM * cos2œÉM)));

    const s = b * A * (œÉ - ŒîœÉ); // Distance en m√®tres
    return s / 1000; // Conversion en kilom√®tres (retourne un nombre)
}

// Fonction de fallback (Haversine)
function distanceHaversine(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // Rayon de la Terre en m√®tres
    const œÜ1 = lat1 * Math.PI / 180;
    const œÜ2 = lat2 * Math.PI / 180;
    const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
    const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return R * c / 1000; // Distance en kilom√®tres (retourne un nombre)
}



function calculerPrixLivraison(distance) {
    if (distance <= 5) {
        return '500 FCFA';
    } else if (distance > 5 && distance <= 10) {
        return '1 000 FCFA';
    } else if (distance > 10 && distance <= 15) {
        return '1 500 FCFA';
    } else if (distance > 15 && distance <= 20) {
        return '2 000 FCFA';
    } else {
        return '√Ä partir de 3 000 FCFA (selon la zone)';
    }
}


function displayColis(colisArray) {
    if (!colisArray?.length) {
        colisList.innerHTML = '<div class="empty-state">üéâ Aucun colis √† livrer pour le moment.</div>';
        return;
    }

    colisList.innerHTML = '';
    colisArray.forEach((colis, index) => {
        const card = document.createElement('article');
        card.className = 'card colis-card animate__animated animate__fadeIn';
        card.dataset.id = colis.codeID;
        card.dataset.expediteurLatitude = colis.expediteur?.localisation?.latitude;
        card.dataset.expediteurLongitude = colis.expediteur?.localisation?.longitude;
        card.dataset.destinataireLatitude = colis.destinataire?.localisation?.latitude;
        card.dataset.destinataireLongitude = colis.destinataire?.localisation?.longitude;
        card.setAttribute('aria-label', `Colis ${colis.codeID}`);

        // Gestion des photos
        const photos = colis.colis?.photos || [];
        const mainPhoto = photos[0]?.data ? photos[0].data : null;

        // Calcul des distances (s'assure que livreurLocation est d√©fini dans la port√©e)
        const distanceExpediteur = livreurLocation && card.dataset.expediteurLatitude && card.dataset.expediteurLongitude
            ? calculerDistance(
                livreurLocation.latitude,
                livreurLocation.longitude,
                parseFloat(card.dataset.expediteurLatitude),
                parseFloat(card.dataset.expediteurLongitude)
            )
            : null;

        const distanceDestinataire = livreurLocation && card.dataset.destinataireLatitude && card.dataset.destinataireLongitude
            ? calculerDistance(
                livreurLocation.latitude,
                livreurLocation.longitude,
                parseFloat(card.dataset.destinataireLatitude),
                parseFloat(card.dataset.destinataireLongitude)
            )
            : null;

        const distanceExpediteurDestinataire = card.dataset.expediteurLatitude && card.dataset.expediteurLongitude && card.dataset.destinataireLatitude && card.dataset.destinataireLongitude
            ? calculerDistance(
                parseFloat(card.dataset.expediteurLatitude),
                parseFloat(card.dataset.expediteurLongitude),
                parseFloat(card.dataset.destinataireLatitude),
                parseFloat(card.dataset.destinataireLongitude)
            )
            : null;

        const prixLivraison = distanceExpediteurDestinataire !== null
            ? calculerPrixLivraison(distanceExpediteurDestinataire)
            : null;

        card.innerHTML = `
            <div class="colis-image-container">
                ${mainPhoto ? `
                    <img src="${mainPhoto}"
                         alt="Image du colis ${colis.codeID}"
                         class="colis-image"
                         loading="${index < 3 ? 'eager' : 'lazy'}">` : `
                    <div class="no-image">üì¶</div>`}
            </div>

            <div class="card-content">
                <h2>Colis #${colis.codeID}</h2>

                <div class="colis-details">
                    <p><strong>Type :</strong> ${colis.colis?.type || 'Non sp√©cifi√©'}</p>
                    <p><strong>D√©tails :</strong> ${colis.colis?.details || 'Aucun d√©tail suppl√©mentaire'}</p>
                </div>

                <div class="coordonnees expediteur">
                    <h3>Exp√©diteur</h3>
                    <p>üë§ <span class="math-inline">\{colis\.expediteur?\.nom \|\| 'Non sp√©cifi√©'\}</p\>
<p\>üìû <a href\="tel\:</span>{colis.expediteur?.telephone || ''}">${colis.expediteur?.telephone || 'Non sp√©cifi√©'}</a></p>
                    ${colis.expediteur?.localisation ? `
                        <p><a href="https://maps.google.com?q=$$${colis.expediteur.localisation.latitude},${colis.expediteur.localisation.longitude}"
                            target="_blank" rel="noopener">
                            üó∫Ô∏è Localiser
                        </a>
<p class="distance"><i class="fas fa-ruler-combined mr-2"></i> LA DISTANCE ENTRE VOUS EST DE : ${distanceExpediteur !== null ? distanceExpediteur.toFixed(3) : 'N/A'} km</p>                         </p>` : ''}
                </div>

                <div class="coordonnees destinataire">
                    <h3>Destinataire</h3>
                    <p>üë§ ${colis.destinataire?.nom || 'Non sp√©cifi√©'} <span class="math-inline">\{colis\.destinataire?\.prenom \|\| ''\}</p\>
<p\>üìû <a href\="tel\:</span>{colis.destinataire?.telephone || ''}">${colis.destinataire?.telephone || 'Non sp√©cifi√©'}</a></p>
                    ${colis.destinataire?.adresse ? `<p>üìç ${colis.destinataire.adresse}</p>` : ''}
                    ${colis.destinataire?.localisation ? `
                        <p><a href="https://maps.google.com?q=$$${colis.destinataire.localisation.latitude},${colis.destinataire.localisation.longitude}"
                            target="_blank" rel="noopener">
                            üó∫Ô∏è Localiser
                        </a>
                            <p class="distance"><i class="fas fa-ruler-combined mr-2"></i>LA DISTANCE ENTRE VOUS EST DE : ${distanceDestinataire !== null ? distanceDestinataire.toFixed(3) : 'N/A'} km</p>
                        </p>` : ''}
                </div>

                <div class="informations-livraison">
                    <h3>Informations de Livraison</h3>
                    ${colis.expediteur?.localisation && colis.destinataire?.localisation ? `
                        <p><i class="fas fa-route mr-2"></i> Distance Entre l'expediteur et le destinataire : ${distanceExpediteurDestinataire !== null ? distanceDestinataire.toFixed(3) : 'N/A'} km</p>
                        <p><i class="fas fa-coins mr-2"></i> Frais de livraison : ${prixLivraison}</p>
                    ` : `<p><i class="fas fa-exclamation-triangle mr-2"></i> Impossible de calculer la distance et le prix (coordonn√©es manquantes).</p>`}
                </div>

                <div class="meta-info">
                    <p><strong>Statut :</strong> <span class="statut <span class="math-inline">\{colis\.statut?\.toLowerCase\(\) \|\| 'inconnu'\}"\></span>{colis.statut || 'Inconnu'}</span></p>
                    <p><strong>Livraison pr√©vue :</strong> ${colis.dateLivraison ? new Date(colis.dateLivraison).toLocaleDateString('fr-FR') : 'Non pr√©cis√©e'}</p>
                </div>

                <div class="button-group">
                    ${colis.estExpedie
                        ? `<p class="text-muted"><i class="fas fa-truck mr-2"></i> En cours de livraison par le livreur #${colis.idLivreurEnCharge || 'Non sp√©cifi√©'}.</p>`
                        : `<button class="expedier-btn btn btn-primary" data-id="${colis.codeID}" aria-label="Exp√©dier le colis ${colis.codeID}">
                                    <i class="fas fa-truck-loading mr-2"></i> Exp√©dier
                                </button>`
                    }
                    <button class="terminer-btn" data-id="${colis.codeID}" aria-label="Livraison Terminer ${colis.codeID}">
    <span class="material-icons animated-check">check_circle</span>

</button>

                </div>
            </div>
        `;

        colisList.appendChild(card);

        // Ajouter le bouton "Actualiser ma position" si le colis est d√©j√† exp√©di√©
        if (colis.estExpedie) {
            setupLocationUpdateButton(card);
        }

        // Gestion du clic sur l'image
        if (mainPhoto) {
            card.querySelector('.colis-image').addEventListener('click', () => {
                const img = new Image();
                img.onload = () => {
                    let maxWidth = window.innerWidth * 0.9;
                    let maxHeight = window.innerHeight * 0.9;
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }

                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }

                    modalImage.style.width = width + 'px';
                    modalImage.style.height = height + 'px';
                    modalImage.src = mainPhoto;
                    modal.classList.add('active');
                };
                img.src = mainPhoto;
            });
        }
    });

    // Gestion des boutons apr√®s l'affichage (principalement pour les boutons "Exp√©dier" et "Terminer")
    setupEventListeners();
}


function setupLocationUpdateButton(card) {
    if (card.querySelector('.update-position-btn')) return;

    const buttonGroup = card.querySelector('.button-group');
    const updateBtn = document.createElement('button');
    updateBtn.className = 'update-position-btn btn btn-info';
    updateBtn.innerHTML = '<span class="material-icons animated-location">location_on</span>';

    updateBtn.onclick = () => {
        const codeID = card.dataset.id;

        // Cr√©er un formulaire pour demander l'ID du livreur
        const formHTML = `
            <div class="update-livreur-id-form animate__animated animate__fadeIn">
                <div class="form-group">
                    <label for="livreur-id-update-<span class="math-inline">\{codeID\}"\><i class\="fas fa\-user mr\-2"\></i\> Votre Identifiant\:</label\>
<input type\="text" id\="livreur\-id\-update\-</span>{codeID}" class="form-control" required placeholder="Saisir votre identifiant">
                </div>
                <div class="button-group-form">
                    <button class="confirm-update-btn btn btn-primary btn-sm" data-id="${codeID}">
                        <i class="fas fa-check mr-2"></i> V√©rifier et Actualiser
                    </button>
                    <button class="cancel-update-btn btn btn-secondary btn-sm">
                        <i class="fas fa-times mr-2"></i> Annuler
                    </button>
                </div>
            </div>
        `;

        updateBtn.insertAdjacentHTML('afterend', formHTML);
        updateBtn.style.display = 'none'; // Masquer le bouton d'actualisation temporairement

        const updateForm = card.querySelector('.update-livreur-id-form');
        const confirmUpdateBtn = updateForm.querySelector('.confirm-update-btn');
        const cancelUpdateBtn = updateForm.querySelector('.cancel-update-btn');
        const livreurIdInput = updateForm.querySelector(`#livreur-id-update-${codeID}`);

        cancelUpdateBtn.addEventListener('click', () => {
            updateForm.classList.remove('animate__fadeIn');
            updateForm.classList.add('animate__fadeOut');
            setTimeout(() => {
                updateForm.remove();
                updateBtn.style.display = 'inline-block'; // R√©afficher le bouton d'actualisation
            }, 300);
        });

        confirmUpdateBtn.addEventListener('click', async () => {
            const livreurIdToVerify = livreurIdInput.value;
            if (!livreurIdToVerify) {
                showToast('‚ö†Ô∏è Veuillez saisir votre identifiant.', 'warning');
                livreurIdInput.classList.add('is-invalid', 'animate__animated', 'animate__shakeX');
                setTimeout(() => {
                    livreurIdInput.classList.remove('is-invalid', 'animate__shakeX');
                }, 1000);
                return;
            }

            confirmUpdateBtn.disabled = true;
            confirmUpdateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> V√©rification...';

            try {
                const verificationResult = await fetch('/.netlify/functions/verifierLivreur', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codeID: codeID, livreurId: livreurIdToVerify }),
                });

                const verificationData = await verificationResult.json();

                if (verificationResult.ok && verificationData.isAuthorized) {
                    // L'identifiant est correct, maintenant r√©cup√©rer la position et mettre √† jour
                    confirmUpdateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Actualisation de la position...';

                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(async (position) => {
                            const localisation = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude
                            };

                            const updateRes = await fetch('/.netlify/functions/updateLivreurPosition', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ codeID: codeID, localisation: localisation }),
                            });

                            if (updateRes.ok) {
                                showToast('üìç Position mise √† jour avec succ√®s', 'success');
                                updateForm.classList.remove('animate__fadeIn');
                                updateForm.classList.add('animate__fadeOut');
                                setTimeout(() => {
                                    updateForm.remove();
                                    updateBtn.style.display = 'inline-block';
                                }, 300);
                            } else {
                                const updateData = await updateRes.json();
                                showToast(`‚ùå Erreur lors de la mise √† jour: ${updateData.error || 'Une erreur inconnue est survenue'}`, 'error');
                                confirmUpdateBtn.innerHTML = '<i class="fas fa-check mr-2"></i> V√©rifier et Actualiser';
                                confirmUpdateBtn.disabled = false;
                            }

                        }, (error) => {
                            showToast(`Erreur de g√©olocalisation: ${error.message}`, 'warning');
                            confirmUpdateBtn.innerHTML = '<i class="fas fa-check mr-2"></i> V√©rifier et Actualiser';
                            confirmUpdateBtn.disabled = false;
                        }, { enableHighAccuracy: true, timeout: 10000 });
                    } else {
                        showToast('üåê La g√©olocalisation n\'est pas support√©e par votre navigateur.', 'error');
                        confirmUpdateBtn.innerHTML = '<i class="fas fa-check mr-2"></i> V√©rifier et Actualiser';
                        confirmUpdateBtn.disabled = false;
                    }

                } else {
                    showToast('üö´ Identifiant incorrect.', 'error');
                    confirmUpdateBtn.innerHTML = '<i class="fas fa-check mr-2"></i> V√©rifier et Actualiser';
                    confirmUpdateBtn.disabled = false;
                    livreurIdInput.classList.add('is-invalid', 'animate__animated', 'animate__shakeX');
                    setTimeout(() => {
                        livreurIdInput.classList.remove('is-invalid', 'animate__shakeX');
                    }, 1000);
                }

            } catch (error) {
                console.error('Erreur lors de la v√©rification de l\'identifiant:', error);
                showToast('‚ö° Erreur de communication avec le serveur.', 'error');
                confirmUpdateBtn.innerHTML = '<i class="fas fa-check mr-2"></i> V√©rifier et Actualiser';
                confirmUpdateBtn.disabled = false;
            }
        });
    };

    buttonGroup.appendChild(updateBtn);
}


function setupEventListeners() {
    // Gestion des boutons "Exp√©dier"
    document.querySelectorAll('.expedier-btn').forEach(btn => {
        btn.addEventListener('click', async function() { // Notez l'utilisation de 'function' pour 'this'
            const codeID = this.dataset.id;
            const card = this.closest('.card');

            const formHTML = `
                <div class="expedition-form animate__animated animate__fadeIn">
                    <h3 class="form-title"><i class="fas fa-truck-loading mr-2"></i> Informations d'exp√©dition</h3>
                    <div class="form-group">
                        <label for="livreur-id-<span class="math-inline">\{codeID\}"\><i class\="fas fa\-user mr\-2"\></i\> Identifiant Livreur\:</label\>
<input type\="text" id\="livreur\-id\-</span>{codeID}" class="form-control" required placeholder="Saisir l'identifiant">
                    </div>
                    <div class="form-group">
                        <label for="livreur-tel1-<span class="math-inline">\{codeID\}"\><i class\="fas fa\-phone mr\-2"\></i\> T√©l√©phone Livreur 1\:</label\>
<input type\="tel" id\="livreur\-tel1\-</span>{codeID}" class="form-control" required placeholder="Num√©ro principal">
                    </div>
                    <div class="form-group">
                        <label for="livreur-tel2-<span class="math-inline">\{codeID\}"\><i class\="fas fa\-phone\-alt mr\-2"\></i\> T√©l√©phone Livreur 2\:</label\>
<input type\="tel" id\="livreur\-tel2\-</span>{codeID}" class="form-control" placeholder="Num√©ro secondaire (optionnel)">
                    </div>
                    <div class="button-group-form"><button class="confirm-expedition-btn btn btn-primary btn-animated" data-id="${codeID}">
                            <span class="btn-inner"><i class="fas fa-check-circle mr-2"></i> Confirmer l'exp√©dition</span>
                            <span class="btn-loading"><i class="fas fa-spinner fa-spin"></i></span>
                        </button>
                        <button class="cancel-expedition-btn btn btn-secondary btn-animated" data-id="${codeID}">
                            <span class="btn-inner"><i class="fas fa-times-circle mr-2"></i> Annuler</span>
                        </button>
                    </div>
                </div>
            `;

            this.insertAdjacentHTML('afterend', formHTML);
            this.classList.add('animate__animated', 'animate__fadeOut');
            setTimeout(() => {
                this.style.display = 'none';
            }, 300);

            const confirmBtn = card.querySelector('.confirm-expedition-btn');
            const cancelBtn = card.querySelector('.cancel-expedition-btn');
            const formDiv = card.querySelector('.expedition-form');

            cancelBtn.addEventListener('click', () => {
                formDiv.classList.remove('animate__fadeIn');
                formDiv.classList.add('animate__fadeOut');
                setTimeout(() => {
                    formDiv.remove();
                    this.classList.remove('animate__fadeOut');
                    this.classList.add('animate__animated', 'animate__fadeIn');
                    this.style.display = 'inline-block';
                }, 300);
            });

            confirmBtn.addEventListener('click', async () => {
                const livreurID = document.getElementById(`livreur-id-${codeID}`).value;
                const livreurTel1 = document.getElementById(`livreur-tel1-${codeID}`).value;
                const livreurTel2 = document.getElementById(`livreur-tel2-${codeID}`).value;

                if (!livreurID || !livreurTel1) {
                    showToast('‚ö†Ô∏è L\'identifiant et le premier num√©ro de t√©l√©phone du livreur sont requis.', 'warning');
                    const idInput = document.getElementById(`livreur-id-${codeID}`);
                    const tel1Input = document.getElementById(`livreur-tel1-${codeID}`);
                    if (!livreurID) idInput.classList.add('is-invalid', 'animate__animated', 'animate__shakeX');
                    if (!livreurTel1) tel1Input.classList.add('is-invalid', 'animate__animated', 'animate__shakeX');
                    setTimeout(() => {
                        idInput.classList.remove('is-invalid', 'animate__shakeX');
                        tel1Input.classList.remove('is-invalid', 'animate__shakeX');
                    }, 1000);
                    return;
                }

                confirmBtn.disabled = true;
                confirmBtn.querySelector('.btn-inner').style.display = 'none';
                confirmBtn.querySelector('.btn-loading').style.display = 'inline-block';
                cancelBtn.disabled = true;
                cancelBtn.classList.add('disabled');

                try {
                    if (navigator.geolocation) {
                        showToast('üõ∞Ô∏è R√©cup√©ration de votre position...', 'info');
                        navigator.geolocation.getCurrentPosition(async (position) => {
                            const localisationLivreur = {
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                            };

                            const expediteurLatitude = parseFloat(card.dataset.expediteurLatitude);
                            const expediteurLongitude = parseFloat(card.dataset.expediteurLongitude);
                            const destinataireLatitude = parseFloat(card.dataset.destinataireLatitude);
                            const destinataireLongitude = parseFloat(card.dataset.destinataireLongitude);

                            let distanceExpediteur = null;
                            if (!isNaN(expediteurLatitude) && !isNaN(expediteurLongitude)) {
                                distanceExpediteur = calculerDistance(
                                    localisationLivreur.latitude,
                                    localisationLivreur.longitude,
                                    expediteurLatitude,
                                    expediteurLongitude
                                );
                            }

                            let distanceDestinataire = null;
                            if (!isNaN(destinataireLatitude) && !isNaN(destinataireLongitude)) {
                                distanceDestinataire = calculerDistance(
                                    localisationLivreur.latitude,
                                    localisationLivreur.longitude,
                                    destinataireLatitude,
                                    destinataireLongitude
                                );
                            }

                            let distanceExpediteurDestinataire = null;
                            if (!isNaN(expediteurLatitude) && !isNaN(expediteurLongitude) && !isNaN(destinataireLatitude) && !isNaN(destinataireLongitude)) {
                                distanceExpediteurDestinataire = calculerDistance(
                                    expediteurLatitude,
                                    expediteurLongitude,
                                    destinataireLatitude,
                                    destinataireLongitude
                                );
                            }

                            const prixLivraison = distanceExpediteurDestinataire !== null
                                ? calculerPrixLivraison(distanceExpediteurDestinataire)
                                : null;

                            const res = await fetch('/.netlify/functions/enregistrerExpedition', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    codeID: codeID,
                                    localisationLivreur: localisationLivreur,
                                    telephoneLivreur1: livreurTel1,
                                    telephoneLivreur2: livreurTel2,
                                    idLivreur: livreurID,
                                    distanceExpediteur: distanceExpediteur,
                                    distanceDestinataire: distanceDestinataire,
                                    distanceExpediteurDestinataire: distanceExpediteurDestinataire,
                                    prixLivraison: prixLivraison,
                                }),
                            });

                            const data = await res.json();

                            if (res.ok) {
                                formDiv.classList.remove('animate__fadeIn');
                                formDiv.classList.add('animate__animated', 'animate__fadeOut', 'animate__faster');
                                setTimeout(() => {
                                    formDiv.style.display = 'none';
                                    card.querySelector('.button-group').innerHTML = `
                                        <p class="info-expedition animate__animated animate__fadeIn"><i class="fas fa-check-double mr-2 text-success"></i> Exp√©dition enregistr√©e !</p>
                                        <p class="instruction-livreur animate__animated animate__fadeIn delay-0-5s"><i class="fas fa-info-circle mr-2 text-info"></i> Veuillez r√©cup√©rer le Colis chez l'exp√©diteur et Le livrer dans les brefs d√©lais !</p>
                                    `;
                                    card.classList.add('en-cours-expedition');
                                    setupLocationUpdateButton(card);
                                }, 300);
                                showToast('‚úÖ Informations d\'exp√©dition enregistr√©es avec succ√®s !', 'success');
                            } else {
                                confirmBtn.innerHTML = '<span class="btn-inner"><i class="fas fa-exclamation-triangle mr-2"></i> Erreur</span><span class="btn-loading"></span>';
                                confirmBtn.disabled = false;
                                confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                                confirmBtn.querySelector('.btn-loading').style.display = 'none';
                                cancelBtn.disabled = false;
                                cancelBtn.classList.remove('disabled');
                                showToast(`‚ùå Erreur lors de l'enregistrement: ${data.error || 'Une erreur inconnue est survenue'}`, 'error');
                            }

                        }, (error) => {
                            confirmBtn.innerHTML = '<span class="btn-inner"><i class="fas fa-exclamation-triangle mr-2"></i> Erreur</span><span class="btn-loading"></span>';
                            confirmBtn.disabled = false;
                            confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                            confirmBtn.querySelector('.btn-loading').style.display = 'none';
                            cancelBtn.disabled = false;
                            cancelBtn.classList.remove('disabled');
                            let errorMessage = 'Erreur lors de la r√©cup√©ration de la localisation.';
                            if (error.code === error.PERMISSION_DENIED) {
                                errorMessage = '‚ö†Ô∏è Autorisation de localisation refus√©e.';
                            } else if (error.code === error.POSITION_UNAVAILABLE) {
                                errorMessage = 'üìç Position indisponible.';
                            } else if (error.code === error.TIMEOUT) {
                                errorMessage = '‚è≥ D√©lai d\'attente pour la localisation d√©pass√©.';
                            }
                            showToast(errorMessage, 'warning');
                        }, { enableHighAccuracy: true, timeout: 10000 });
                    } else {
                        confirmBtn.innerHTML = '<span class="btn-inner"><i class="fas fa-exclamation-triangle mr-2"></i> Erreur</span><span class="btn-loading"></span>';
                        confirmBtn.disabled = false;
                        confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                        confirmBtn.querySelector('.btn-loading').style.display = 'none';
                        cancelBtn.disabled = false;
                        cancelBtn.classList.remove('disabled');
                        showToast('üåê La g√©olocalisation n\'est pas support√©e par votre navigateur.', 'error');
                    }
                } catch (e) {
                    confirmBtn.innerHTML = '<span class="btn-inner"><i class="fas fa-exclamation-triangle mr-2"></i> Erreur</span><span class="btn-loading"></span>';
                    confirmBtn.disabled = false;
                    confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                    confirmBtn.querySelector('.btn-loading').style.display = 'none';
                    cancelBtn.disabled = false;
                    cancelBtn.classList.remove('disabled');
                    showToast('‚ö° Erreur de connexion au serveur.', 'error');
                }
            });
        });
    });


        // Gestion des boutons "Terminer"
        document.querySelectorAll('.terminer-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const codeID = btn.dataset.id;
            const card = btn.closest('.card');

          // Cr√©ation de la modale d'alerte personnalis√©e
      const modalAlert = document.createElement('div');
      modalAlert.className = 'custom-alert animate__animated animate__fadeIn';
      modalAlert.innerHTML = `
        <div class="alert-content">
          <h3 class="alert-title"><i class="fas fa-question-circle mr-2"></i> Confirmer la livraison ?</h3>
          <p>√ätes-vous s√ªr de vouloir marquer le colis <strong>#${codeID}</strong> comme livr√© ? Cette action est irr√©versible et n√©cessitera vos informations.</p>
          <div class="alert-buttons">
            <button class="btn btn-secondary cancel-alert-btn"><i class="fas fa-times mr-2"></i> Annuler</button>
            <button class="btn btn-success confirm-alert-btn" data-id="${codeID}"><i class="fas fa-check mr-2"></i> Confirmer</button>
          </div>
        </div>
      `;
      document.body.appendChild(modalAlert);

      // Gestion du bouton "Annuler" de l'alerte
      const cancelAlertBtn = modalAlert.querySelector('.cancel-alert-btn');
      cancelAlertBtn.addEventListener('click', () => {
        modalAlert.classList.remove('animate__fadeIn');
        modalAlert.classList.add('animate__fadeOut');
        setTimeout(() => modalAlert.remove(), 300);
      });

      // Gestion du bouton "Confirmer" de l'alerte
      const confirmAlertBtn = modalAlert.querySelector('.confirm-alert-btn');
      confirmAlertBtn.addEventListener('click', async () => {
        const nomLivreur = prompt("Nom du livreur :", "");
        const prenomLivreur = prompt("Pr√©nom du livreur :", "");
        const idLivreur = prompt("Identifiant du livreur :", "");

        if (!nomLivreur || !prenomLivreur || !idLivreur) {
          showToast('Veuillez fournir le nom, le pr√©nom et l\'identifiant du livreur.', 'warning');
          return;
        }

        // Fermer l'alerte
        modalAlert.classList.remove('animate__fadeIn');
        modalAlert.classList.add('animate__fadeOut');
        setTimeout(() => modalAlert.remove(), 300);

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Finalisation...';

        try {
          const res = await fetch('/.netlify/functions/deleteLivraison', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codeID, nomLivreur, prenomLivreur, idLivreur }),
          });

          const data = await res.json();

          if (res.ok) {
            showToast('Livraison termin√©e et colis supprim√© avec succ√®s', 'success');
            card.classList.add('animate__animated', 'animate__fadeOut');
            setTimeout(() => {
              card.remove();
              if (!document.querySelectorAll('.card').length) {
                colisList.innerHTML = '<div class="empty-state">üéâ Tous les colis ont √©t√© livr√©s !</div>';
              }
            }, 300);
          } else {
            btn.innerHTML = '‚úÖ Terminer';
            btn.disabled = false;
            showToast(data.error || 'Erreur lors de la finalisation', 'error');
          }
        } catch (e) {
          btn.innerHTML = '‚úÖ Terminer';
          btn.disabled = false;
          showToast('Erreur de connexion au serveur', 'error');
        }
      });



      async function updateLivreurPosition(codeID) {
    try {
        if (!navigator.geolocation) {
            showToast('La g√©olocalisation n\'est pas support√©e par votre navigateur', 'error');
            return;
        }

        showToast('üõ∞Ô∏è R√©cup√©ration de votre position...', 'info');
        
        navigator.geolocation.getCurrentPosition(async (position) => {
            const localisation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
            };

            const res = await fetch('/.netlify/functions/mettreAJourLocalisation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codeID, localisation }),
            });

            if (res.ok) {
                showToast('üìç Position mise √† jour avec succ√®s', 'success');
            } else {
                const data = await res.json();
                showToast(`Erreur: ${data.error || 'Impossible de mettre √† jour la position'}`, 'error');
            }
        }, (error) => {
            let errorMessage = 'Erreur de g√©olocalisation';
            if (error.code === error.PERMISSION_DENIED) {
                errorMessage = 'Autorisation de localisation refus√©e';
            }
            showToast(errorMessage, 'error');
        });
    } catch (e) {
        showToast('Erreur de connexion au serveur', 'error');
    }
}







            // Cr√©ation d'un formulaire modale pour la confirmation de livraison
            const formHTML = `
              <div class="terminer-form animate__animated animate__fadeIn">
                <h3 class="form-title"><i class="fas fa-check-circle mr-2"></i> Confirmation de livraison</h3>
                <div class="form-group">
                  <label for="nom-livreur-${codeID}"><i class="fas fa-user mr-2"></i> Nom du livreur:</label>
                  <input type="text" id="nom-livreur-${codeID}" class="form-control" required placeholder="Votre nom">
                </div>
                <div class="form-group">
                  <label for="prenom-livreur-${codeID}"><i class="fas fa-user mr-2"></i> Pr√©nom du livreur:</label>
                  <input type="text" id="prenom-livreur-${codeID}" class="form-control" required placeholder="Votre pr√©nom">
                </div>
                <div class="form-group">
                  <label for="id-livreur-${codeID}"><i class="fas fa-id-card mr-2"></i> Identifiant livreur:</label>
                  <input type="text" id="id-livreur-${codeID}" class="form-control" required placeholder="Votre identifiant">
                </div>
                <div class="button-group-form">
                  <button class="confirm-terminer-btn btn btn-success btn-animated" data-id="${codeID}">
                    <span class="btn-inner"><i class="fas fa-check mr-2"></i> Confirmer la livraison</span>
                    <span class="btn-loading"><i class="fas fa-spinner fa-spin"></i></span>
                  </button>
                  <button class="cancel-terminer-btn btn btn-secondary btn-animated" data-id="${codeID}">
                    <span class="btn-inner"><i class="fas fa-times mr-2"></i> Annuler</span>
                  </button>
                </div>
              </div>
            `;

            btn.insertAdjacentHTML('afterend', formHTML);
            btn.style.display = 'none';

            const confirmBtn = card.querySelector('.confirm-terminer-btn');
            const cancelBtn = card.querySelector('.cancel-terminer-btn');
            const formDiv = card.querySelector('.terminer-form');

            cancelBtn.addEventListener('click', () => {
              formDiv.classList.remove('animate__fadeIn');
              formDiv.classList.add('animate__fadeOut');
              setTimeout(() => {
                formDiv.remove();
                btn.style.display = 'inline-block';
              }, 300);
            });

            confirmBtn.addEventListener('click', async () => {
              const nomLivreur = document.getElementById(`nom-livreur-${codeID}`).value;
              const prenomLivreur = document.getElementById(`prenom-livreur-${codeID}`).value;
              const idLivreur = document.getElementById(`id-livreur-${codeID}`).value;

              if (!nomLivreur || !prenomLivreur || !idLivreur) {
                showToast('Veuillez remplir tous les champs obligatoires', 'warning');
                return;
              }

              confirmBtn.disabled = true;
              confirmBtn.querySelector('.btn-inner').style.display = 'none';
              confirmBtn.querySelector('.btn-loading').style.display = 'inline-block';
              cancelBtn.disabled = true;

              try {
                const res = await fetch('/.netlify/functions/deleteLivraison', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ 
                    codeID, 
                    nomLivreur, 
                    prenomLivreur, 
                    idLivreur 
                  }),
                });

                const data = await res.json();

                if (res.ok) {
                  showToast('Livraison termin√©e avec succ√®s', 'success');
                  card.classList.add('animate__animated', 'animate__fadeOut');
                  setTimeout(() => {
                    card.remove();
                    if (!document.querySelectorAll('.card').length) {
                      colisList.innerHTML = '<div class="empty-state">üéâ Tous les colis ont √©t√© livr√©s !</div>';
                    }
                  }, 300);
                } else {
                  confirmBtn.disabled = false;
                  confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                  confirmBtn.querySelector('.btn-loading').style.display = 'none';
                  cancelBtn.disabled = false;
                  showToast(data.error || 'Erreur lors de la finalisation', 'error');
                }
              } catch (e) {
                confirmBtn.disabled = false;
                confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                confirmBtn.querySelector('.btn-loading').style.display = 'none';
                cancelBtn.disabled = false;
                showToast('Erreur de connexion au serveur', 'error');
              }
            });
          });
        });
      }



      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;

        const closeBtn = document.createElement('span');
        closeBtn.textContent = '√ó';
        closeBtn.className = 'close-btn';
        closeBtn.onclick = () => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        };
        toast.appendChild(closeBtn);

        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);

        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }

      // D√©marrer l'application
      getLocation();

      // Rafra√Æchir toutes les 5 minutes
      setInterval(fetchColis, 300000);


  
    });
  </script>

<div class="navigation-arrows">
  <a href="Connection.html" class="arrow left-arrow" aria-label="Page pr√©c√©dente">
    <svg viewBox="0 0 24 24">
      <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"/>
    </svg>
  </a>
  <button class="arrow refresh-button" aria-label="Actualiser la page" onclick="location.reload();">
    <svg viewBox="0 0 24 24">
      <path fill="currentColor" d="M17.65 6.35A7.9 7.9 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08v-4h6v4H17.65zM12 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
    </svg>
  </button>
</div>


</body>
</html>