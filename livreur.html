<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Interface livreur pour la gestion des colis">
  <title>ğŸ“¦ Interface Livreur | Gestion des Colis</title>
  <link rel="stylesheet" href="livreur.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
  <div class="container">
    <header>
      <h1>Interface Livreur</h1>
      <p id="location-status" aria-live="polite">ğŸ“ Localisation en cours...</p>
    </header>

    <main>
      <div id="colis-list" class="colis-container"></div>
    </main>
  </div>

  <!-- Modale pour image agrandie -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <img id="modalImage" alt="Image agrandie du colis">
    </div>
    <span id="modalClose" class="modal-close" aria-label="Fermer la modale">&times;</span>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const locationStatus = document.getElementById('location-status');
      const colisList = document.getElementById('colis-list');
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      const modalClose = document.getElementById('modalClose');
      let livreurLocation = null;

      // Gestion de la modale d'image
      modalClose.addEventListener('click', () => {
        modal.classList.remove('active');
      });

      // Obtenir la position du livreur
      const getLocation = () => {
        if ('geolocation' in navigator) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              livreurLocation = {
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude,
              };
              locationStatus.innerHTML = `ğŸ“ <a href="https://www.google.com/maps?q=${livreurLocation.latitude},${livreurLocation.longitude}" target="_blank" style="color: blue; text-decoration: underline;">Voir ma position sur Google Maps</a>`;
              locationStatus.classList.add('success');
              fetchColis();
            },
            err => {
              locationStatus.textContent = 'âš ï¸ Impossible d\'obtenir la localisation (activez-la pour une meilleure expÃ©rience)';
              locationStatus.classList.add('error');
              fetchColis();
            },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        } else {
          locationStatus.textContent = 'âš ï¸ GÃ©olocalisation non supportÃ©e par votre navigateur';
          locationStatus.classList.add('error');
          fetchColis();
        }
      };

      // RÃ©cupÃ©rer la liste des colis depuis l'API
      async function fetchColis() {
        try {
          colisList.innerHTML = '<div class="loading">Chargement des colis...</div>';
          
          const res = await fetch('/.netlify/functions/getLivraisons');
          const data = await res.json();
          
          if (res.ok) {
            displayColis(data);
          } else {
            colisList.innerHTML = `<div class="error-message">Erreur: ${data.error || 'Impossible de charger les colis'}</div>`;
          }
        } catch (e) {
          console.error('Erreur fetch:', e);
          colisList.innerHTML = '<div class="error-message">Erreur de connexion au serveur</div>';
        }
      }

      function displayColis(colisArray) {
        if (!colisArray?.length) {
          colisList.innerHTML = '<div class="empty-state">ğŸ‰ Aucun colis Ã  livrer pour le moment.</div>';
          return;
        }

        colisList.innerHTML = '';
        colisArray.forEach((colis, index) => {
          const card = document.createElement('article');
          card.className = 'card';
          card.setAttribute('data-id', colis.codeID);
          card.setAttribute('aria-label', `Colis ${colis.codeID}`);

          // Gestion des photos
          const photos = colis.colis?.photos || [];
          const mainPhoto = photos[0]?.data ? photos[0].data : null;
          const hasMultiplePhotos = photos.length > 1;

          card.innerHTML = `
            <div class="colis-image-container">
              ${mainPhoto ? `
                <img src="${mainPhoto}" 
                     alt="Image du colis ${colis.codeID}" 
                     class="colis-image"
                     loading="${index < 3 ? 'eager' : 'lazy'}">` : `
                <div class="no-image">ğŸ“¦</div>`}
            </div>

            <div class="card-content">
              <h2>Colis #${colis.codeID}</h2>
              
              <div class="colis-details">
                <p><strong>Type :</strong> ${colis.colis.type || 'Non spÃ©cifiÃ©'}</p>
                <p><strong>DÃ©tails :</strong> ${colis.colis.details || 'Aucun dÃ©tail supplÃ©mentaire'}</p>
              </div>

              <div class="coordonnees expediteur">
                <h3>ExpÃ©diteur</h3>
                <p>ğŸ‘¤ ${colis.expediteur.nom}</p>
                <p>ğŸ“ <a href="tel:${colis.expediteur.telephone}">${colis.expediteur.telephone}</a></p>
                ${colis.expediteur.localisation ? `
                  <p><a href="https://maps.google.com?q=${colis.expediteur.localisation.latitude},${colis.expediteur.localisation.longitude}" 
                        target="_blank" rel="noopener">
                    ğŸ—ºï¸ Localiser
                  </a></p>` : ''}
              </div>

              <div class="coordonnees destinataire">
                <h3>Destinataire</h3>
                <p>ğŸ‘¤ ${colis.destinataire.nom} ${colis.destinataire.prenom}</p>
                <p>ğŸ“ <a href="tel:${colis.destinataire.telephone}">${colis.destinataire.telephone}</a></p>
                ${colis.destinataire.localisation ? `
                  <p><a href="https://maps.google.com?q=${colis.destinataire.localisation.latitude},${colis.destinataire.localisation.longitude}" 
                        target="_blank" rel="noopener">
                    ğŸ—ºï¸ Localiser
                  </a></p>` : ''}
              </div>

              <div class="meta-info">
                <p><strong>Statut :</strong> <span class="statut ${colis.statut.toLowerCase()}">${colis.statut}</span></p>
                <p><strong>Livraison prÃ©vue :</strong> ${colis.dateLivraison ? new Date(colis.dateLivraison).toLocaleDateString('fr-FR') : 'Non prÃ©cisÃ©e'}</p>
              </div>

              <div class="button-group">
                <button class="expedier-btn" data-id="${colis.codeID}" aria-label="ExpÃ©dier le colis ${colis.codeID}">
                  ğŸ“¤ ExpÃ©dier
                </button>
                <button class="terminer-btn" data-id="${colis.codeID}" aria-label="Terminer la livraison du colis ${colis.codeID}">
                  âœ… Terminer
                </button>
              </div>
            </div>
          `;

          colisList.appendChild(card);

          // Gestion du clic sur l'image
          if (mainPhoto) {
            card.querySelector('.colis-image').addEventListener('click', () => {
              modalImage.src = mainPhoto;
              modal.classList.add('active');
            });
          }
        });

        // Gestion des boutons
        setupEventListeners();
      }

      function setupEventListeners() {
        // Bouton "ExpÃ©dier"
        document.querySelectorAll('.expedier-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const codeID = btn.dataset.id;
            const card = btn.closest('.card');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> En cours...';
            
            try {
              const res = await fetch('/.netlify/functions/expedierColis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codeID }),
              });
              
              const data = await res.json();
              
              if (res.ok) {
                btn.innerHTML = 'âœ“ ExpÃ©diÃ©';
                card.classList.add('expedie');
              } else {
                btn.innerHTML = 'ğŸ“¤ ExpÃ©dier';
                btn.disabled = false;
                showToast(data.error || 'Erreur lors de l\'expÃ©dition', 'error');
              }
            } catch (e) {
              btn.innerHTML = 'ğŸ“¤ ExpÃ©dier';
              btn.disabled = false;
              showToast('Erreur de connexion', 'error');
            }
          });
        });

        // Bouton "Terminer"
        document.querySelectorAll('.terminer-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const codeID = btn.dataset.id;
            
            if (!confirm(`Confirmer la livraison du colis #${codeID} ? Cette action est irrÃ©versible.`)) {
              return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Finalisation...';
            
            try {
              const res = await fetch('/.netlify/functions/terminerColis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codeID }),
              });
              
              const data = await res.json();
              
              if (res.ok) {
                showToast('Livraison terminÃ©e avec succÃ¨s', 'success');
                btn.closest('.card').classList.add('fade-out');
                setTimeout(() => {
                  btn.closest('.card').remove();
                  if (!document.querySelectorAll('.card').length) {
                    colisList.innerHTML = '<div class="empty-state">ğŸ‰ Tous les colis ont Ã©tÃ© livrÃ©s !</div>';
                  }
                }, 300);
              } else {
                btn.innerHTML = 'âœ… Terminer';
                btn.disabled = false;
                showToast(data.error || 'Erreur lors de la finalisation', 'error');
              }
            } catch (e) {
              btn.innerHTML = 'âœ… Terminer';
              btn.disabled = false;
              showToast('Erreur de connexion au serveur', 'error');
            }
          });
        });
      }

      function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;

    // Bouton de fermeture
    const closeBtn = document.createElement('span');
    closeBtn.textContent = 'Ã—';
    closeBtn.className = 'close-btn';
    closeBtn.onclick = () => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    };
    toast.appendChild(closeBtn);

    // Ajout au body
    document.body.appendChild(toast);

    // Affichage avec animation
    setTimeout(() => toast.classList.add('show'), 100);

    // Disparition automatique aprÃ¨s 4s
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}
      // DÃ©marrer l'application
      getLocation();

      // RafraÃ®chir toutes les 5 minutes
      setInterval(fetchColis, 300000);
    });
  </script>
</body>
</html>