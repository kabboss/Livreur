<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Interface livreur pour la gestion des colis">
  <title>üì¶ Interface Livreur | Gestion des Colis</title>
  <link rel="stylesheet" href="livreur.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>


  <div class="navigation-arrows">
    <a href="Connection.html" class="arrow left-arrow" aria-label="Page pr√©c√©dente">
      <svg viewBox="0 0 24 24">
        <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"/>
      </svg>
    </a>
    <button class="arrow refresh-button" aria-label="Actualiser la page" onclick="location.reload();">
      <svg viewBox="0 0 24 24">
        <path fill="currentColor" d="M17.65 6.35A7.9 7.9 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08v-4h6v4H17.65zM12 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
      </svg>
    </button>
  </div>



  
  <div class="container">
    <header>
      <h1>Interface Livreur</h1>
      <p id="location-status" aria-live="polite">üìç Localisation en cours...</p>
    </header>

    <main>
      <div id="colis-list" class="colis-container"></div>
    </main>
  </div>

  <!-- Modale pour image agrandie -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <img id="modalImage" alt="Image agrandie du colis">
    </div>
    <span id="modalClose" class="modal-close" aria-label="Fermer la modale">&times;</span>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const locationStatus = document.getElementById('location-status');
      const colisList = document.getElementById('colis-list');
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      const modalClose = document.getElementById('modalClose');
      let livreurLocation = null;

      // Gestion de la modale d'image
      modalClose.addEventListener('click', () => {
        modal.classList.remove('active');
      });

      // Obtenir la position du livreur
      const getLocation = () => {
        if ('geolocation' in navigator) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              livreurLocation = {
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude,
              };
              locationStatus.innerHTML = `üìç <a href="https://www.google.com/maps?q=${livreurLocation.latitude},${livreurLocation.longitude}" target="_blank" style="color: blue; text-decoration: underline;">Voir ma position sur Google Maps</a>`;
              locationStatus.classList.add('success');
              fetchColis();
            },
            err => {
              locationStatus.textContent = '‚ö†Ô∏è Impossible d\'obtenir la localisation (activez-la pour une meilleure exp√©rience)';
              locationStatus.classList.add('error');
              fetchColis();
            },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        } else {
          locationStatus.textContent = '‚ö†Ô∏è G√©olocalisation non support√©e par votre navigateur';
          locationStatus.classList.add('error');
          fetchColis();
        }
      };

// R√©cup√©rer la liste des colis depuis l'API
async function fetchColis() {
  try {
    colisList.innerHTML = '<div class="loading">Chargement des colis...</div>';

    const res = await fetch('/.netlify/functions/getLivraisons');
    const data = await res.json();

    if (res.ok) {
      displayColis(data);
    } else {
      colisList.innerHTML = `<div class="error-message">Erreur: ${data.error || 'Impossible de charger les colis'}</div>`;
    }
  } catch (e) {
    console.error('Erreur fetch:', e);
    colisList.innerHTML = '<div class="error-message">Erreur de connexion au serveur</div>';
  }
 }

 function displayColis(colisArray) {
  if (!colisArray?.length) {
    colisList.innerHTML = '<div class="empty-state">üéâ Aucun colis √† livrer pour le moment.</div>';
    return;
  }

  colisList.innerHTML = '';
  colisArray.forEach((colis, index) => {
    const card = document.createElement('article');
    card.className = 'card';
    card.setAttribute('data-id', colis.codeID);
    card.setAttribute('aria-label', `Colis ${colis.codeID}`);

    // Gestion des photos
    const photos = colis.colis?.photos || [];
    const mainPhoto = photos[0]?.data ? photos[0].data : null;
    const hasMultiplePhotos = photos.length > 1;

    card.innerHTML = `
      <div class="colis-image-container">
        ${mainPhoto ? `
          <img src="${mainPhoto}"
               alt="Image du colis ${colis.codeID}"
               class="colis-image"
               loading="${index < 3 ? 'eager' : 'lazy'}">` : `
          <div class="no-image">üì¶</div>`}
      </div>

      <div class="card-content">
        <h2>Colis #${colis.codeID}</h2>

        <div class="colis-details">
          <p><strong>Type :</strong> ${colis.colis.type || 'Non sp√©cifi√©'}</p>
          <p><strong>D√©tails :</strong> ${colis.colis.details || 'Aucun d√©tail suppl√©mentaire'}</p>
        </div>

        <div class="coordonnees expediteur">
          <h3>Exp√©diteur</h3>
          <p>üë§ <span class="math-inline">\{colis\.expediteur\.nom\}</p\>
<p\>üìû <a href\="tel\:</span>{colis.expediteur.telephone}">${colis.expediteur.telephone}</a></p>
          ${colis.expediteur.localisation ? `
            <p><a href="https://maps.google.com?q=$?q=${colis.expediteur.localisation.latitude},${colis.expediteur.localisation.longitude}"
                  target="_blank" rel="noopener">
              üó∫Ô∏è Localiser
            </a></p>` : ''}
        </div>

        <div class="coordonnees destinataire">
          <h3>Destinataire</h3>
          <p>üë§ ${colis.destinataire.nom} <span class="math-inline">\{colis\.destinataire\.prenom\}</p\>
<p\>üìû <a href\="tel\:</span>{colis.destinataire.telephone}">${colis.destinataire.telephone}</a></p>
          ${colis.destinataire.adresse ? `<p>üìç ${colis.destinataire.adresse}</p>` : ''}
          ${colis.destinataire.localisation ? `
            <p><a href="https://maps.google.com?q=$$?q=${colis.destinataire.localisation.latitude},${colis.destinataire.localisation.longitude}"
                  target="_blank" rel="noopener">
              üó∫Ô∏è Localiser
            </a></p>` : ''}
        </div>

        <div class="meta-info">
          <p><strong>Statut :</strong> <span class="statut <span class="math-inline">\{colis\.statut\.toLowerCase\(\)\}"\></span>{colis.statut}</span></p>
          <p><strong>Livraison pr√©vue :</strong> ${colis.dateLivraison ? new Date(colis.dateLivraison).toLocaleDateString('fr-FR') : 'Non pr√©cis√©e'}</p>
        </div>

        <div class="button-group">
          ${colis.estExpedie
            ? '<p class="text-muted"><i class="fas fa-lock mr-2"></i> Ce colis est en cours d\'exp√©dition.</p>'
            : `<button class="expedier-btn" data-id="${colis.codeID}" aria-label="Exp√©dier le colis ${colis.codeID}">
                <i class="fas fa-truck-loading mr-2"></i> Exp√©dier
              </button>`
          }
          <button class="terminer-btn" data-id="${colis.codeID}" aria-label="Livraison Terminer ${colis.codeID}">
            ‚úÖ Terminer
          </button>
        </div>
      </div>
    `;

    colisList.appendChild(card);

    // Gestion du clic sur l'image
    if (mainPhoto) {
      card.querySelector('.colis-image').addEventListener('click', () => {
        const img = new Image();
        img.onload = () => {
          let maxWidth = window.innerWidth * 0.9; // 90% de la largeur de la fen√™tre
          let maxHeight = window.innerHeight * 0.9; // 90% de la hauteur de la fen√™tre
          let width = img.width;
          let height = img.height;

          if (width > maxWidth) {
            height *= maxWidth / width;
            width = maxWidth;
          }

          if (height > maxHeight) {
            width *= maxHeight / height;
            height = maxHeight;
          }

          modalImage.style.width = width + 'px';
          modalImage.style.height = height + 'px';
          modalImage.src = mainPhoto;
          modal.classList.add('active');
        };
        img.src = mainPhoto;
      });
    }
  });

  // Gestion des boutons apr√®s l'affichage
  setupEventListeners();
 }

 function setupEventListeners() {
  // S√©lectionne tous les boutons "Exp√©dier" et attache un √©couteur d'√©v√©nements √† chacun.
  document.querySelectorAll('.expedier-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      // R√©cup√®re l'identifiant unique du colis √† partir de l'attribut "data-id" du bouton.
      const codeID = btn.dataset.id;
      // Remonte √† l'√©l√©ment de carte parent pour manipuler son contenu.
      const card = btn.closest('.card');

      // Cr√©e dynamiquement le formulaire de saisie des informations du livreur.
      const formHTML = `
        <div class="expedition-form animate__animated animate__fadeIn">
          <h3 class="form-title"><i class="fas fa-truck-loading mr-2"></i> Informations d'exp√©dition</h3>
          <div class="form-group">
            <label for="livreur-id-<span class="math-inline">\{codeID\}"\><i class\="fas fa\-user mr\-2"\></i\> Identifiant Livreur\:</label\>
<input type\="text" id\="livreur\-id\-</span>{codeID}" class="form-control" required placeholder="Saisir l'identifiant">
          </div>
          <div class="form-group">
            <label for="livreur-tel1-<span class="math-inline">\{codeID\}"\><i class\="fas fa\-phone mr\-2"\></i\> T√©l√©phone Livreur 1\:</label\>
<input type\="tel" id\="livreur\-tel1\-</span>{codeID}" class="form-control" required placeholder="Num√©ro principal">
          </div>
          <div class="form-group">
            <label for="livreur-tel2-<span class="math-inline">\{codeID\}"\><i class\="fas fa\-phone\-alt mr\-2"\></i\> T√©l√©phone Livreur 2\:</label\>
<input type\="tel" id\="livreur\-tel2\-</span>{codeID}" class="form-control" placeholder="Num√©ro secondaire (optionnel)">
          </div>
          <div class="button-group-form">
            <button class="confirm-expedition-btn btn btn-primary btn-animated" data-id="<span class="math-inline">\{codeID\}"\>
<span class\="btn\-inner"\><i class\="fas fa\-check\-circle mr\-2"\></i\> Confirmer l'exp√©dition</span\>
<span class\="btn\-loading"\><i class\="fas fa\-spinner fa\-spin"\></i\></span\>
</button\>
<button class\="cancel\-expedition\-btn btn btn\-secondary btn\-animated" data\-id\="</span>{codeID}">
              <span class="btn-inner"><i class="fas fa-times-circle mr-2"></i> Annuler</span>
            </button>
          </div>
        </div>
      `;

      // Ins√®re le formulaire juste apr√®s le bouton "Exp√©dier" avec une animation d'apparition.
      btn.insertAdjacentHTML('afterend', formHTML);
      // Cache le bouton "Exp√©dier" initial avec une animation de disparition progressive.
      btn.classList.add('animate__animated', 'animate__fadeOut');
      setTimeout(() => {
        btn.style.display = 'none';
      }, 300);

      // S√©lectionne les √©l√©ments du formulaire nouvellement cr√©√©s.
      const confirmBtn = card.querySelector('.confirm-expedition-btn');
      const cancelBtn = card.querySelector('.cancel-expedition-btn');
      const formDiv = card.querySelector('.expedition-form');

      // Gestionnaire d'√©v√©nement pour le bouton "Annuler".
      cancelBtn.addEventListener('click', () => {
        // Supprime le formulaire avec une animation de disparition progressive.
        formDiv.classList.remove('animate__fadeIn');
        formDiv.classList.add('animate__fadeOut');
        setTimeout(() => {
          formDiv.remove();
          // R√©affiche le bouton "Exp√©dier" avec une animation d'apparition progressive.
          btn.classList.remove('animate__fadeOut');
          btn.classList.add('animate__animated', 'animate__fadeIn');
          btn.style.display = 'inline-block';
        }, 300);
      });

      // Gestionnaire d'√©v√©nement pour le bouton "Confirmer l'exp√©dition".
      confirmBtn.addEventListener('click', async () => {
        // R√©cup√®re les valeurs saisies par le livreur.
        const livreurID = document.getElementById(`livreur-id-${codeID}`).value;
        const livreurTel1 = document.getElementById(`livreur-tel1-${codeID}`).value;
        const livreurTel2 = document.getElementById(`livreur-tel2-${codeID}`).value;

        // Validation des champs obligatoires avec un feedback visuel.
        if (!livreurID || !livreurTel1) {
          showToast('‚ö†Ô∏è L\'identifiant et le premier num√©ro de t√©l√©phone du livreur sont requis.', 'warning');
          const idInput = document.getElementById(`livreur-id-${codeID}`);
          const tel1Input = document.getElementById(`livreur-tel1-${codeID}`);
          if (!livreurID) idInput.classList.add('is-invalid', 'animate__animated', 'animate__shakeX');
          if (!livreurTel1) tel1Input.classList.add('is-invalid', 'animate__animated', 'animate__shakeX');
          setTimeout(() => {
            idInput.classList.remove('is-invalid', 'animate__shakeX');
            tel1Input.classList.remove('is-invalid', 'animate__shakeX');
          }, 1000);
          return;
        }

        // D√©sactive les boutons et affiche un indicateur de chargement dynamique.
        confirmBtn.disabled = true;
        confirmBtn.querySelector('.btn-inner').style.display = 'none';
        confirmBtn.querySelector('.btn-loading').style.display = 'inline-block';
        cancelBtn.disabled = true;
        cancelBtn.classList.add('disabled');

        try {
          // Tentative de r√©cup√©ration de la localisation du livreur avec un message informatif.
          if (navigator.geolocation) {
            showToast('üõ∞Ô∏è R√©cup√©ration de votre position...', 'info');
            navigator.geolocation.getCurrentPosition(async (position) => {
              const localisationLivreur = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
              };

              // Envoi des donn√©es d'exp√©dition au serveur via une requ√™te POST anim√©e.
              const res = await fetch('/.netlify/functions/enregistrerExpedition', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  codeID: codeID,
                  localisationLivreur: localisationLivreur,
                  telephoneLivreur1: livreurTel1,
                  telephoneLivreur2: livreurTel2,
                  idLivreur: livreurID,
                }),
              });

              const data = await res.json();

              // Gestion de la r√©ponse du serveur avec des animations et des messages clairs.
              if (res.ok) {
                formDiv.classList.remove('animate__fadeIn');
                formDiv.classList.add('animate__animated', 'animate__fadeOut', 'animate__faster');
                setTimeout(() => {
                  formDiv.remove();
                  card.querySelector('.button-group').innerHTML = `
                    <p class="info-expedition animate__animated animate__fadeIn"><i class="fas fa-check-double mr-2 text-success"></i> Exp√©dition enregistr√©e !</p>
                    <p class="instruction-livreur animate__animated animate__fadeIn delay-0-5s"><i class="fas fa-info-circle mr-2 text-info"></i> Veuillez r√©cup√©rer le Colis chez l'exp√©diteur et Le livrer dans les brefs d√©lais !</p>
                    <button class="update-location-btn btn btn-outline-primary btn-sm mt-2 animate__animated animate__fadeIn delay-1s" data-id="${codeID}">
                      <i class="fas fa-map-marker-alt mr-2"></i> Actuliser ma position
                    </button>
                  `;
                  card.classList.add('en-cours-expedition');
                  setupLocationUpdateButton(card); // Initialiser l'√©couteur pour le nouveau bouton
                }, 300);
                showToast('‚úÖ Informations d\'exp√©dition enregistr√©es avec succ√®s !', 'success');
              } else {
                // Affichage d'un message d'erreur dynamique.
                confirmBtn.innerHTML = '<span class="btn-inner"><i class="fas fa-exclamation-triangle mr-2"></i> Erreur</span><span class="btn-loading"></span>';
                confirmBtn.disabled = false;
                confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                confirmBtn.querySelector('.btn-loading').style.display = 'none';
                cancelBtn.disabled = false;
                cancelBtn.classList.remove('disabled');
                showToast(`‚ùå Erreur lors de l'enregistrement: ${data.error || 'Une erreur inconnue est survenue'}`, 'error');
              }

            }, (error) => {
              // Gestion des erreurs de g√©olocalisation avec des messages sp√©cifiques.
              confirmBtn.innerHTML = '<span class="btn-inner"><i class="fas fa-exclamation-triangle mr-2"></i> Erreur</span><span class="btn-loading"></span>';
              confirmBtn.disabled = false;
              confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
              confirmBtn.querySelector('.btn-loading').style.display = 'none';
              cancelBtn.disabled = false;
              cancelBtn.classList.remove('disabled');
              let errorMessage = 'Erreur lors de la r√©cup√©ration de la localisation.';
              if (error.code === error.PERMISSION_DENIED) {
                errorMessage = '‚ö†Ô∏è Autorisation de localisation refus√©e.';
              } else if (error.code === error.POSITION_UNAVAILABLE) {
                errorMessage = 'üìç Position indisponible.';
              } else if (error.code === error.TIMEOUT) {
                errorMessage = '‚è≥ D√©lai d\'attente pour la localisation d√©pass√©.';
              }
              showToast(errorMessage, 'warning');
            });
          } else {
            // Message si la g√©olocalisation n'est pas support√©e.
            confirmBtn.innerHTML = '<span class="btn-inner"><i class="fas fa-exclamation-triangle mr-2"></i> Erreur</span><span class="btn-loading"></span>';
            confirmBtn.disabled = false;
            confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
            confirmBtn.querySelector('.btn-loading').style.display = 'none';
            cancelBtn.disabled = false;
            cancelBtn.classList.remove('disabled');
            showToast('üåê La g√©olocalisation n\'est pas support√©e par votre navigateur.', 'error');
          }

        } catch (e) {
          // Gestion des erreurs de connexion g√©n√©rales.
          confirmBtn.innerHTML = '<span class="btn-inner"><i class="fas fa-exclamation-triangle mr-2"></i> Erreur</span><span class="btn-loading"></span>';
          confirmBtn.disabled = false;
          confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
          confirmBtn.querySelector('.btn-loading').style.display = 'none';
          cancelBtn.disabled = false;
          cancelBtn.classList.remove('disabled');
          showToast('‚ö° Erreur de connexion au serveur.', 'error');
        }

      });
    });
  });
}

function setupLocationUpdateButton(cardElement) {
  const updateButton = cardElement.querySelector('.update-location-btn');
  if (updateButton) {
    updateButton.addEventListener('click', async () => {
      const codeID = updateButton.dataset.id;
      updateButton.disabled = true;
      updateButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Mise √† jour...';

      if (navigator.geolocation) {
        showToast('üõ∞Ô∏è Tentative de mise √† jour de votre position...', 'info');
        navigator.geolocation.getCurrentPosition(async (position) => {
          const nouvelleLocalisation = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
          };

          try {
            const res = await fetch('/.netlify/functions/mettreAJourLocalisation', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ codeID: codeID, localisation: nouvelleLocalisation }),
            });

            const data = await res.json();

            if (res.ok) {
              updateButton.innerHTML = '<i class="fas fa-map-marker-alt mr-2 text-success"></i> Position mise √† jour !';
              showToast('üìç Votre position a √©t√© mise √† jour avec succ√®s !', 'success');
              setTimeout(() => {
                updateButton.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i> Actuliser ma position';
                updateButton.disabled = false;
              }, 3000);
            } else {
              updateButton.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Erreur';
              updateButton.disabled = false;
              showToast(`‚ùå Erreur lors de la mise √† jour de la localisation: ${data.error || 'Une erreur inconnue est survenue'}`, 'error');
            }
          } catch (error) {
            updateButton.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Erreur';
            updateButton.disabled = false;
            showToast('‚ö° Erreur de connexion lors de la mise √† jour de la localisation.', 'error');
          }
        }, (error) => {
          updateButton.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i> Actuliser ma position';
          updateButton.disabled = false;
          let errorMessage = 'Erreur lors de la r√©cup√©ration de la localisation.';
          if (error.code === error.PERMISSION_DENIED) {
            errorMessage = '‚ö†Ô∏è Autorisation de localisation refus√©e.';
          } else if (error.code === error.POSITION_UNAVAILABLE) {
            errorMessage = 'üìç Position indisponible.';
          } else if (error.code === error.TIMEOUT) {
            errorMessage = '‚è≥ D√©lai d\'attente pour la localisation d√©pass√©.';
          }
          showToast(errorMessage, 'warning');
        });
      } else {
        updateButton.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i> Actuliser ma position';
        updateButton.disabled = false;
        showToast('üåê La g√©olocalisation n\'est pas support√©e par votre navigateur.', 'error');
      }
    });
  }
 

 // Initialisation au chargement de la page
 fetchColis();





        // Bouton "Terminer"
        document.querySelectorAll('.terminer-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const codeID = btn.dataset.id;
            
            if (!confirm(`Confirmer la livraison du colis #${codeID} ? Cette action est irr√©versible.`)) {
              return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Finalisation...';
            
            try {
              const res = await fetch('/.netlify/functions/terminerColis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codeID }),
              });
              
              const data = await res.json();
              
              if (res.ok) {
                showToast('Livraison termin√©e avec succ√®s', 'success');
                btn.closest('.card').classList.add('fade-out');
                setTimeout(() => {
                  btn.closest('.card').remove();
                  if (!document.querySelectorAll('.card').length) {
                    colisList.innerHTML = '<div class="empty-state">üéâ Tous les colis ont √©t√© livr√©s !</div>';
                  }
                }, 300);
              } else {
                btn.innerHTML = '‚úÖ Terminer';
                btn.disabled = false;
                showToast(data.error || 'Erreur lors de la finalisation', 'error');
              }
            } catch (e) {
              btn.innerHTML = '‚úÖ Terminer';
              btn.disabled = false;
              showToast('Erreur de connexion au serveur', 'error');
            }
          });
        });
      }

      function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;

    // Bouton de fermeture
    const closeBtn = document.createElement('span');
    closeBtn.textContent = '√ó';
    closeBtn.className = 'close-btn';
    closeBtn.onclick = () => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    };
    toast.appendChild(closeBtn);

    // Ajout au body
    document.body.appendChild(toast);

    // Affichage avec animation
    setTimeout(() => toast.classList.add('show'), 100);

    // Disparition automatique apr√®s 4s
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}
      // D√©marrer l'application
      getLocation();

      // Rafra√Æchir toutes les 5 minutes
      setInterval(fetchColis, 300000);
    });
  </script>
</body>
</html>