<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interface Livreur</title>
  <link rel="stylesheet" href="livreur.css" />
</head>
<body>
  <div class="container">
    <h1>üì¶ Interface Livreur</h1>
    <p id="location-status">üìç Localisation en cours...</p>
    <div id="colis-list"></div>
  </div>
  <script src="livreur.js"></script>




<script>
    document.addEventListener('DOMContentLoaded', () => {
  const locationStatus = document.getElementById('location-status');
  const colisList = document.getElementById('colis-list');
  let livreurLocation = null;

  // Obtenir la localisation du livreur
  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        livreurLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
        };
        locationStatus.textContent = `üìç Localisation d√©tect√©e: ${livreurLocation.latitude.toFixed(5)}, ${livreurLocation.longitude.toFixed(5)}`;
        fetchColis();
      },
      (error) => {
        locationStatus.textContent = '‚ö†Ô∏è Impossible de d√©tecter la localisation.';
        console.error(error);
        fetchColis();
      }
    );
  } else {
    locationStatus.textContent = '‚ö†Ô∏è G√©olocalisation non support√©e par ce navigateur.';
    fetchColis();
  }

  // R√©cup√©rer les colis √† livrer
  async function fetchColis() {
    try {
      const response = await fetch('/.netlify/functions/getLivraisons');
      const data = await response.json();

      if (response.ok) {
        displayColis(data);
      } else {
        colisList.innerHTML = `<p>Erreur: ${data.error}</p>`;
      }
    } catch (err) {
      console.error(err);
      colisList.innerHTML = '<p>Erreur de connexion au serveur.</p>';
    }
  }

  // Fonction pour afficher les colis
  function displayColis(colisArray) {
    if (colisArray.length === 0) {
      colisList.innerHTML = '<p>Aucun colis √† livrer.</p>';
      return;
    }

    colisList.innerHTML = '';

    colisArray.forEach((colis) => {
      const card = document.createElement('div');
      card.className = 'colis-card';

      // R√©cup√©ration de la premi√®re image
      let imageHTML = '';
      if (colis.colis?.photos?.length > 0) {
        const imgData = colis.colis.photos[0].data;

        // V√©rifie si c'est d√©j√† une URL ou une cha√Æne base64
        const isURL = imgData.startsWith('http');
        const src = isURL ? imgData : `data:image/jpeg;base64,${imgData}`;

        imageHTML = `
          <img src="${src}" alt="Photo du colis" class="colis-image" style="max-width: 100%; height: auto; margin-bottom: 10px;" />
        `;
      }

      // Voir plus d'images
      let voirPlusHTML = '';
      if (colis.colis.photos.length > 1) {
        voirPlusHTML = `
          <span class="voir-plus" onclick="alert('Voir plus bient√¥t disponible !')">
            Voir plus d'images (${colis.colis.photos.length - 1})
          </span>
        `;
      }

      // Construction de la carte
      card.innerHTML = `
        <h2>Colis #${colis.codeID}</h2>
        ${imageHTML}
        ${voirPlusHTML}

        <div class="colis-details">
          <p><strong>Type:</strong> ${colis.colis.type}</p>
          <p><strong>Exp√©diteur:</strong> ${colis.expediteur.nom} (${colis.expediteur.telephone})</p>
          ${colis.expediteur.localisation ? `
            <p class="coordonnees">üìç 
              <a href="https://www.google.com/maps?q=${colis.expediteur.localisation.latitude},${colis.expediteur.localisation.longitude}" 
                 target="_blank" rel="noopener noreferrer">
                Localiser l'exp√©diteur
              </a>
            </p>` : ''}

          <p><strong>Destinataire:</strong> ${colis.destinataire.nom} ${colis.destinataire.prenom} (${colis.destinataire.telephone})</p>
          <p><strong>Adresse:</strong> ${colis.destinataire.adresse}</p>
          ${colis.destinataire.localisation ? `
            <p class="coordonnees">üìç 
              <a href="https://www.google.com/maps?q=${colis.destinataire.localisation.latitude},${colis.destinataire.localisation.longitude}" 
                 target="_blank" rel="noopener noreferrer">
                Localiser le destinataire
              </a>
            </p>` : ''}

          ${livreurLocation ? `
            <p class="coordonnees">üõµ 
              <a href="https://www.google.com/maps?q=${livreurLocation.latitude},${livreurLocation.longitude}" 
                 target="_blank" rel="noopener noreferrer">
                Ma position (Livreur)
              </a>
            </p>` : ''}
        </div>

        <div class="button-group">
          <button class="expedier-btn" data-id="${colis.codeID}">Exp√©dier</button>
          <button class="terminer-btn" data-id="${colis.codeID}">Terminer</button>
        </div>
      `;

      colisList.appendChild(card);
    });

    // Gestion de la modale image
    document.querySelectorAll('.colis-image').forEach(img => {
      img.addEventListener('click', () => {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        modal.style.display = 'flex';
        modalImg.src = img.src;
      });
    });

    // Fermer la modale
    document.getElementById('modalClose').addEventListener('click', () => {
      document.getElementById('imageModal').style.display = 'none';
    });

    // Bouton Exp√©dier
    document.querySelectorAll('.expedier-btn').forEach((btn) => {
      btn.addEventListener('click', async () => {
        if (btn.classList.contains('disabled')) return;

        const codeID = btn.getAttribute('data-id');
        try {
          const response = await fetch('/.netlify/functions/expedierColis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codeID }),
          });

          const result = await response.json();

          if (response.ok) {
            btn.textContent = 'En cours d\'exp√©dition';
            btn.classList.add('disabled');
          } else {
            alert(result.error || 'Erreur lors de la mise √† jour.');
          }
        } catch (err) {
          console.error(err);
          alert('Erreur de connexion au serveur.');
        }
      });
    });

    // Bouton Terminer
    document.querySelectorAll('.terminer-btn').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const codeID = btn.getAttribute('data-id');
        if (!confirm('Confirmez-vous la livraison de ce colis ?')) return;

        try {
          const response = await fetch('/.netlify/functions/terminerColis', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codeID }),
          });

          const result = await response.json();

          if (response.ok) {
            btn.closest('.colis-card').remove();
          } else {
            alert(result.error || 'Erreur lors de la suppression.');
          }
        } catch (err) {
          console.error(err);
          alert('Erreur de connexion au serveur.');
        }
      });
    });
  }
})
</script>


<!-- Modale pour image agrandie -->
<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; justify-content:center; align-items:center; background-color:rgba(0,0,0,0.8); z-index:999;">
  <img id="modalImage" style="max-width:90%; max-height:90%;" />
  <span id="modalClose" style="position:absolute; top:20px; right:30px; font-size:30px; color:white; cursor:pointer;">&times;</span>
</div>




</body>
</html>