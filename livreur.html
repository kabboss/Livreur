<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interface Livreur</title>
  <link rel="stylesheet" href="livreur.css" />
</head>
<body>
  <div class="container">
    <h1>📦 Interface Livreur</h1>
    <p id="location-status">📍 Localisation en cours...</p>
    <div id="colis-list"></div>
  </div>
  <script src="livreur.js"></script>




  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const locationStatus = document.getElementById('location-status');
      const colisList = document.getElementById('colis-list');
      let livreurLocation = null;
    
      // Obtenir la position du livreur
      if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            livreurLocation = {
              latitude: pos.coords.latitude,
              longitude: pos.coords.longitude,
            };
            locationStatus.textContent = `📍 Ma position : ${livreurLocation.latitude.toFixed(5)}, ${livreurLocation.longitude.toFixed(5)}`;
            fetchColis();
          },
          err => {
            locationStatus.textContent = '⚠️ Impossible d’obtenir la localisation.';
            fetchColis();
          }
        );
      } else {
        locationStatus.textContent = '⚠️ Géolocalisation non supportée.';
        fetchColis();
      }
    
      // Récupérer la liste des colis depuis l’API
      async function fetchColis() {
        try {
          const res = await fetch('/.netlify/functions/getLivraisons');
          const data = await res.json();
          if (res.ok) displayColis(data);
          else colisList.innerHTML = `<p>Erreur: ${data.error}</p>`;
        } catch (e) {
          console.error(e);
          colisList.innerHTML = '<p>Erreur de connexion au serveur.</p>';
        }
      }
    
      // Afficher chaque colis
      function displayColis(colisArray) {
        if (!colisArray.length) {
          colisList.innerHTML = '<p>Aucun colis à livrer.</p>';
          return;
        }
    
        colisList.innerHTML = '';
        colisArray.forEach(colis => {
          const card = document.createElement('div');
          card.className = 'colis-card';
    
          const photo = colis.colis?.photos?.[0];
          const photoSrc = photo ? (photo.startsWith('http') ? photo : `data:image/jpeg;base64,${photo}`) : null;
    
          card.innerHTML = `
            <h2>📦 Colis #${colis.codeID}</h2>
            ${photo ? `<img src="${photoSrc}" alt="Image du colis" class="colis-image"/>` : ''}
            ${colis.colis?.photos?.length > 1 ? `<span class="voir-plus">Voir plus (${colis.colis.photos.length - 1})</span>` : ''}
            
            <p><strong>Type :</strong> ${colis.colis.type}</p>
            <p><strong>Détails :</strong> ${colis.colis.details || 'Non spécifié'}</p>
    
            <hr/>
    
            <p><strong>👤 Expéditeur :</strong> ${colis.expediteur.nom}</p>
            <p><strong>📞 Tél :</strong> ${colis.expediteur.telephone}</p>
            ${colis.expediteur.localisation ? `
              <p><a href="https://www.google.com/maps?q=${colis.expediteur.localisation.latitude},${colis.expediteur.localisation.longitude}" target="_blank">🗺️ Localiser l'expéditeur</a></p>` : ''}
    
            <hr/>
    
            <p><strong>👤 Destinataire :</strong> ${colis.destinataire.nom} ${colis.destinataire.prenom}</p>
            <p><strong>📞 Tél :</strong> ${colis.destinataire.telephone}</p>
            <p><strong>📍 Adresse :</strong> ${colis.destinataire.adresse}</p>
            ${colis.destinataire.localisation ? `
              <p><a href="https://www.google.com/maps?q=${colis.destinataire.localisation.latitude},${colis.destinataire.localisation.longitude}" target="_blank">🗺️ Localiser le destinataire</a></p>` : ''}
    
            <hr/>
    
            <p><strong>📅 Date de livraison prévue :</strong> ${colis.dateLivraison ? new Date(colis.dateLivraison).toLocaleDateString() : 'Non précisée'}</p>
            <p><strong>🚚 Statut :</strong> ${colis.statut}</p>
            ${livreurLocation ? `<p>🧭 Ma position : <a href="https://www.google.com/maps?q=${livreurLocation.latitude},${livreurLocation.longitude}" target="_blank">${livreurLocation.latitude.toFixed(5)}, ${livreurLocation.longitude.toFixed(5)}</a></p>` : ''}
    
            <div class="button-group">
              <button class="expedier-btn" data-id="${colis.codeID}">📤 Expédier</button>
              <button class="terminer-btn" data-id="${colis.codeID}">✅ Terminer</button>
            </div>
          `;
    
          colisList.appendChild(card);
        });
    
        // Gestion des clics "Voir plus"
        document.querySelectorAll('.voir-plus').forEach(span => {
          span.addEventListener('click', () => {
            alert('Fonctionnalité "Voir plus" à venir !');
          });
        });
    
        // Bouton "Expédier"
        document.querySelectorAll('.expedier-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const codeID = btn.dataset.id;
            btn.disabled = true;
            btn.textContent = '⏳ En cours...';
            try {
              const res = await fetch('/.netlify/functions/expedierColis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codeID }),
              });
              const data = await res.json();
              if (res.ok) {
                btn.textContent = '📤 Expédié';
              } else {
                btn.textContent = '📤 Expédier';
                btn.disabled = false;
                alert(data.error || 'Erreur lors de l’expédition');
              }
            } catch (e) {
              alert('Erreur de connexion.');
              btn.disabled = false;
              btn.textContent = '📤 Expédier';
            }
          });
        });
    
        // Bouton "Terminer"
        document.querySelectorAll('.terminer-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const codeID = btn.dataset.id;
            if (!confirm(`Confirmer la livraison du colis #${codeID} ?`)) return;
    
            try {
              const res = await fetch('/.netlify/functions/terminerColis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codeID }),
              });
              const data = await res.json();
              if (res.ok) {
                btn.closest('.colis-card').remove();
              } else {
                alert(data.error || 'Erreur lors de la finalisation');
              }
            } catch (e) {
              alert('Erreur de connexion au serveur.');
            }
          });
        });
      }
    });
    </script>
    

<!-- Modale pour image agrandie -->
<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; justify-content:center; align-items:center; background-color:rgba(0,0,0,0.8); z-index:999;">
  <img id="modalImage" style="max-width:90%; max-height:90%;" />
  <span id="modalClose" style="position:absolute; top:20px; right:30px; font-size:30px; color:white; cursor:pointer;">&times;</span>
</div>




</body>
</html>