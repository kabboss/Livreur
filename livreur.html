<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Interface livreur pour la gestion des colis">
  <title>📦 Interface Livreur | Gestion des Colis</title>
  <link rel="stylesheet" href="livreur.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>

  <div class="navigation-arrows">
    <a href="Connection.html" class="arrow left-arrow" aria-label="Page précédente">
      <svg viewBox="0 0 24 24">
        <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"/>
      </svg>
    </a>
    <button class="arrow refresh-button" aria-label="Actualiser la page" onclick="location.reload();">
      <svg viewBox="0 0 24 24">
        <path fill="currentColor" d="M17.65 6.35A7.9 7.9 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08v-4h6v4H17.65zM12 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
      </svg>
    </button>
  </div>

  <div class="container">
    <header>
      <h1>Interface Livreur</h1>
      <p id="location-status" aria-live="polite">📍 Localisation en cours...</p>
    </header>

    <main>
      <div id="colis-list" class="colis-container"></div>
    </main>
  </div>

  <!-- Modale pour image agrandie -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <img id="modalImage" alt="Image agrandie du colis">
    </div>
    <span id="modalClose" class="modal-close" aria-label="Fermer la modale">&times;</span>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const locationStatus = document.getElementById('location-status');
      const colisList = document.getElementById('colis-list');
      const modal = document.getElementById('imageModal');
      const modalImage = document.getElementById('modalImage');
      const modalClose = document.getElementById('modalClose');
      let livreurLocation = null;

      // Gestion de la modale d'image
      modalClose.addEventListener('click', () => {
        modal.classList.remove('active');
      });

      // Obtenir la position du livreur
      const getLocation = () => {
        if ('geolocation' in navigator) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              livreurLocation = {
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude,
              };
              locationStatus.innerHTML = `📍 <a href="https://www.google.com/maps?q=${livreurLocation.latitude},${livreurLocation.longitude}" target="_blank" style="color: blue; text-decoration: underline;">Voir ma position sur Google Maps</a>`;
              locationStatus.classList.add('success');
              fetchColis();
            },
            err => {
              locationStatus.textContent = '⚠️ Impossible d\'obtenir la localisation (activez-la pour une meilleure expérience)';
              locationStatus.classList.add('error');
              fetchColis();
            },
            { enableHighAccuracy: true, timeout: 10000 }
          );
        } else {
          locationStatus.textContent = '⚠️ Géolocalisation non supportée par votre navigateur';
          locationStatus.classList.add('error');
          fetchColis();
        }
      };

      // Récupérer la liste des colis depuis l'API
      async function fetchColis() {
        try {
          colisList.innerHTML = '<div class="loading">Chargement des colis...</div>';

          const res = await fetch('/.netlify/functions/getLivraisons');
          const data = await res.json();

          if (res.ok) {
            displayColis(data);
          } else {
            colisList.innerHTML = `<div class="error-message">Erreur: ${data.error || 'Impossible de charger les colis'}</div>`;
          }
        } catch (e) {
          console.error('Erreur fetch:', e);
          colisList.innerHTML = '<div class="error-message">Erreur de connexion au serveur</div>';
        }
      }

      function displayColis(colisArray) {
        if (!colisArray?.length) {
          colisList.innerHTML = '<div class="empty-state">🎉 Aucun colis à livrer pour le moment.</div>';
          return;
        }

        colisList.innerHTML = '';
        colisArray.forEach((colis, index) => {
          const card = document.createElement('article');
          card.className = 'card';
          card.setAttribute('data-id', colis.codeID);
          card.setAttribute('aria-label', `Colis ${colis.codeID}`);

          // Gestion des photos
          const photos = colis.colis?.photos || [];
          const mainPhoto = photos[0]?.data ? photos[0].data : null;
          const hasMultiplePhotos = photos.length > 1;

          card.innerHTML = `
            <div class="colis-image-container">
              ${mainPhoto ? `
                <img src="${mainPhoto}"
                     alt="Image du colis ${colis.codeID}"
                     class="colis-image"
                     loading="${index < 3 ? 'eager' : 'lazy'}">` : `
                <div class="no-image">📦</div>`}
            </div>

            <div class="card-content">
              <h2>Colis #${colis.codeID}</h2>

              <div class="colis-details">
                <p><strong>Type :</strong> ${colis.colis.type || 'Non spécifié'}</p>
                <p><strong>Détails :</strong> ${colis.colis.details || 'Aucun détail supplémentaire'}</p>
              </div>

              <div class="coordonnees expediteur">
                <h3>Expéditeur</h3>
                <p>👤 ${colis.expediteur.nom}</p>
                <p>📞 <a href="tel:${colis.expediteur.telephone}">${colis.expediteur.telephone}</a></p>
                ${colis.expediteur.localisation ? `
                  <p><a href="https://maps.google.com?q=${colis.expediteur.localisation.latitude},${colis.expediteur.localisation.longitude}"
                        target="_blank" rel="noopener">
                    🗺️ Localiser
                  </a></p>` : ''}
              </div>

              <div class="coordonnees destinataire">
                <h3>Destinataire</h3>
                <p>👤 ${colis.destinataire.nom} ${colis.destinataire.prenom}</p>
                <p>📞 <a href="tel:${colis.destinataire.telephone}">${colis.destinataire.telephone}</a></p>
                ${colis.destinataire.adresse ? `<p>📍 ${colis.destinataire.adresse}</p>` : ''}
                ${colis.destinataire.localisation ? `
                  <p><a href="https://maps.google.com?q=${colis.destinataire.localisation.latitude},${colis.destinataire.localisation.longitude}"
                      target="_blank" rel="noopener">
                    🗺️ Localiser
                  </a></p>` : ''}
              </div>

              <div class="meta-info">
                <p><strong>Statut :</strong> <span class="statut ${colis.statut.toLowerCase()}">${colis.statut}</span></p>
                <p><strong>Livraison prévue :</strong> ${colis.dateLivraison ? new Date(colis.dateLivraison).toLocaleDateString('fr-FR') : 'Non précisée'}</p>
              </div>

              <div class="button-group">
                ${colis.estExpedie
                  ? `<p class="text-muted"><i class="fas fa-truck mr-2"></i> En cours de livraison par le livreur #${colis.idLivreurEnCharge || 'Non spécifié'}.</p>`
                  : `<button class="expedier-btn btn btn-primary" data-id="${colis.codeID}" aria-label="Expédier le colis ${colis.codeID}">
                      <i class="fas fa-truck-loading mr-2"></i> Expédier
                    </button>`
                }
                <button class="terminer-btn" data-id="${colis.codeID}" aria-label="Livraison Terminer ${colis.codeID}">
                  ✅ Terminer
                </button>
              </div>
            </div>
          `;

          colisList.appendChild(card);

          // Gestion du clic sur l'image
          if (mainPhoto) {
            card.querySelector('.colis-image').addEventListener('click', () => {
              const img = new Image();
              img.onload = () => {
                let maxWidth = window.innerWidth * 0.9;
                let maxHeight = window.innerHeight * 0.9;
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                  height *= maxWidth / width;
                  width = maxWidth;
                }

                if (height > maxHeight) {
                  width *= maxHeight / height;
                  height = maxHeight;
                }

                modalImage.style.width = width + 'px';
                modalImage.style.height = height + 'px';
                modalImage.src = mainPhoto;
                modal.classList.add('active');
              };
              img.src = mainPhoto;
            });
          }
        });

        // Gestion des boutons après l'affichage
        setupEventListeners();
      }

      function setupEventListeners() {
        // Gestion des boutons "Expédier"
        document.querySelectorAll('.expedier-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const codeID = btn.dataset.id;
            const card = btn.closest('.card');

            const formHTML = `
              <div class="expedition-form animate__animated animate__fadeIn">
                <h3 class="form-title"><i class="fas fa-truck-loading mr-2"></i> Informations d'expédition</h3>
                <div class="form-group">
                  <label for="livreur-id-${codeID}"><i class="fas fa-user mr-2"></i> Identifiant Livreur:</label>
                  <input type="text" id="livreur-id-${codeID}" class="form-control" required placeholder="Saisir l'identifiant">
                </div>
                <div class="form-group">
                  <label for="livreur-tel1-${codeID}"><i class="fas fa-phone mr-2"></i> Téléphone Livreur 1:</label>
                  <input type="tel" id="livreur-tel1-${codeID}" class="form-control" required placeholder="Numéro principal">
                </div>
                <div class="form-group">
                  <label for="livreur-tel2-${codeID}"><i class="fas fa-phone-alt mr-2"></i> Téléphone Livreur 2:</label>
                  <input type="tel" id="livreur-tel2-${codeID}" class="form-control" placeholder="Numéro secondaire (optionnel)">
                </div>
                <div class="button-group-form">
                  <button class="confirm-expedition-btn btn btn-primary btn-animated" data-id="${codeID}">
                    <span class="btn-inner"><i class="fas fa-check-circle mr-2"></i> Confirmer l'expédition</span>
                    <span class="btn-loading"><i class="fas fa-spinner fa-spin"></i></span>
                  </button>
                  <button class="cancel-expedition-btn btn btn-secondary btn-animated" data-id="${codeID}">
                    <span class="btn-inner"><i class="fas fa-times-circle mr-2"></i> Annuler</span>
                  </button>
                </div>
              </div>
            `;

            btn.insertAdjacentHTML('afterend', formHTML);
            btn.classList.add('animate__animated', 'animate__fadeOut');
            setTimeout(() => {
              btn.style.display = 'none';
            }, 300);

            const confirmBtn = card.querySelector('.confirm-expedition-btn');
            const cancelBtn = card.querySelector('.cancel-expedition-btn');
            const formDiv = card.querySelector('.expedition-form');

            cancelBtn.addEventListener('click', () => {
              formDiv.classList.remove('animate__fadeIn');
              formDiv.classList.add('animate__fadeOut');
              setTimeout(() => {
                formDiv.remove();
                btn.classList.remove('animate__fadeOut');
                btn.classList.add('animate__animated', 'animate__fadeIn');
                btn.style.display = 'inline-block';
              }, 300);
            });

            confirmBtn.addEventListener('click', async () => {
              const livreurID = document.getElementById(`livreur-id-${codeID}`).value;
              const livreurTel1 = document.getElementById(`livreur-tel1-${codeID}`).value;
              const livreurTel2 = document.getElementById(`livreur-tel2-${codeID}`).value;

              if (!livreurID || !livreurTel1) {
                showToast('⚠️ L\'identifiant et le premier numéro de téléphone du livreur sont requis.', 'warning');
                const idInput = document.getElementById(`livreur-id-${codeID}`);
                const tel1Input = document.getElementById(`livreur-tel1-${codeID}`);
                if (!livreurID) idInput.classList.add('is-invalid', 'animate__animated', 'animate__shakeX');
                if (!livreurTel1) tel1Input.classList.add('is-invalid', 'animate__animated', 'animate__shakeX');
                setTimeout(() => {
                  idInput.classList.remove('is-invalid', 'animate__shakeX');
                  tel1Input.classList.remove('is-invalid', 'animate__shakeX');
                }, 1000);
                return;
              }

              confirmBtn.disabled = true;
              confirmBtn.querySelector('.btn-inner').style.display = 'none';
              confirmBtn.querySelector('.btn-loading').style.display = 'inline-block';
              cancelBtn.disabled = true;
              cancelBtn.classList.add('disabled');

              try {
                if (navigator.geolocation) {
                  showToast('🛰️ Récupération de votre position...', 'info');
                  navigator.geolocation.getCurrentPosition(async (position) => {
                    const localisationLivreur = {
                      latitude: position.coords.latitude,
                      longitude: position.coords.longitude,
                    };

                    const res = await fetch('/.netlify/functions/enregistrerExpedition', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        codeID: codeID,
                        localisationLivreur: localisationLivreur,
                        telephoneLivreur1: livreurTel1,
                        telephoneLivreur2: livreurTel2,
                        idLivreur: livreurID,
                      }),
                    });

                    const data = await res.json();

                    if (res.ok) {
                      formDiv.classList.remove('animate__fadeIn');
                      formDiv.classList.add('animate__animated', 'animate__fadeOut', 'animate__faster');
                      setTimeout(() => {
                        formDiv.remove();
                        card.querySelector('.button-group').innerHTML = `
                          <p class="info-expedition animate__animated animate__fadeIn"><i class="fas fa-check-double mr-2 text-success"></i> Expédition enregistrée !</p>
                          <p class="instruction-livreur animate__animated animate__fadeIn delay-0-5s"><i class="fas fa-info-circle mr-2 text-info"></i> Veuillez récupérer le Colis chez l'expéditeur et Le livrer dans les brefs délais !</p>
                          <button class="update-location-btn btn btn-outline-primary btn-sm mt-2 animate__animated animate__fadeIn delay-1s" data-id="${codeID}">
                            <i class="fas fa-map-marker-alt mr-2"></i> Actuliser ma position
                          </button>
                        `;
                        card.classList.add('en-cours-expedition');
                        setupLocationUpdateButton(card);
                      }, 300);
                      showToast('✅ Informations d\'expédition enregistrées avec succès !', 'success');
                    } else {
                      confirmBtn.innerHTML = '<span class="btn-inner"><i class="fas fa-exclamation-triangle mr-2"></i> Erreur</span><span class="btn-loading"></span>';
                      confirmBtn.disabled = false;
                      confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                      confirmBtn.querySelector('.btn-loading').style.display = 'none';
                      cancelBtn.disabled = false;
                      cancelBtn.classList.remove('disabled');
                      showToast(`❌ Erreur lors de l'enregistrement: ${data.error || 'Une erreur inconnue est survenue'}`, 'error');
                    }

                  }, (error) => {
                    confirmBtn.innerHTML = '<span class="btn-inner"><i class="fas fa-exclamation-triangle mr-2"></i> Erreur</span><span class="btn-loading"></span>';
                    confirmBtn.disabled = false;
                    confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                    confirmBtn.querySelector('.btn-loading').style.display = 'none';
                    cancelBtn.disabled = false;
                    cancelBtn.classList.remove('disabled');
                    let errorMessage = 'Erreur lors de la récupération de la localisation.';
                    if (error.code === error.PERMISSION_DENIED) {
                      errorMessage = '⚠️ Autorisation de localisation refusée.';
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                      errorMessage = '📍 Position indisponible.';
                    } else if (error.code === error.TIMEOUT) {
                      errorMessage = '⏳ Délai d\'attente pour la localisation dépassé.';
                    }
                    showToast(errorMessage, 'warning');
                  });
                } else {
                  confirmBtn.innerHTML = '<span class="btn-inner"><i class="fas fa-exclamation-triangle mr-2"></i> Erreur</span><span class="btn-loading"></span>';
                  confirmBtn.disabled = false;
                  confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                  confirmBtn.querySelector('.btn-loading').style.display = 'none';
                  cancelBtn.disabled = false;
                  cancelBtn.classList.remove('disabled');
                  showToast('🌐 La géolocalisation n\'est pas supportée par votre navigateur.', 'error');
                }
              } catch (e) {
                confirmBtn.innerHTML = '<span class="btn-inner"><i class="fas fa-exclamation-triangle mr-2"></i> Erreur</span><span class="btn-loading"></span>';
                confirmBtn.disabled = false;
                confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                confirmBtn.querySelector('.btn-loading').style.display = 'none';
                cancelBtn.disabled = false;
                cancelBtn.classList.remove('disabled');
                showToast('⚡ Erreur de connexion au serveur.', 'error');
              }
            });
          });
        });

        // Gestion des boutons "Terminer"
        document.querySelectorAll('.terminer-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const codeID = btn.dataset.id;
            const card = btn.closest('.card');

            if (!confirm(`Confirmer la livraison du colis #${codeID} ? Cette action est irréversible et nécessitera vos informations.`)) {
              return;
            }

            // Création d'un formulaire modale pour la confirmation de livraison
            const formHTML = `
              <div class="terminer-form animate__animated animate__fadeIn">
                <h3 class="form-title"><i class="fas fa-check-circle mr-2"></i> Confirmation de livraison</h3>
                <div class="form-group">
                  <label for="nom-livreur-${codeID}"><i class="fas fa-user mr-2"></i> Nom du livreur:</label>
                  <input type="text" id="nom-livreur-${codeID}" class="form-control" required placeholder="Votre nom">
                </div>
                <div class="form-group">
                  <label for="prenom-livreur-${codeID}"><i class="fas fa-user mr-2"></i> Prénom du livreur:</label>
                  <input type="text" id="prenom-livreur-${codeID}" class="form-control" required placeholder="Votre prénom">
                </div>
                <div class="form-group">
                  <label for="id-livreur-${codeID}"><i class="fas fa-id-card mr-2"></i> Identifiant livreur:</label>
                  <input type="text" id="id-livreur-${codeID}" class="form-control" required placeholder="Votre identifiant">
                </div>
                <div class="button-group-form">
                  <button class="confirm-terminer-btn btn btn-success btn-animated" data-id="${codeID}">
                    <span class="btn-inner"><i class="fas fa-check mr-2"></i> Confirmer la livraison</span>
                    <span class="btn-loading"><i class="fas fa-spinner fa-spin"></i></span>
                  </button>
                  <button class="cancel-terminer-btn btn btn-secondary btn-animated" data-id="${codeID}">
                    <span class="btn-inner"><i class="fas fa-times mr-2"></i> Annuler</span>
                  </button>
                </div>
              </div>
            `;

            btn.insertAdjacentHTML('afterend', formHTML);
            btn.style.display = 'none';

            const confirmBtn = card.querySelector('.confirm-terminer-btn');
            const cancelBtn = card.querySelector('.cancel-terminer-btn');
            const formDiv = card.querySelector('.terminer-form');

            cancelBtn.addEventListener('click', () => {
              formDiv.classList.remove('animate__fadeIn');
              formDiv.classList.add('animate__fadeOut');
              setTimeout(() => {
                formDiv.remove();
                btn.style.display = 'inline-block';
              }, 300);
            });

            confirmBtn.addEventListener('click', async () => {
              const nomLivreur = document.getElementById(`nom-livreur-${codeID}`).value;
              const prenomLivreur = document.getElementById(`prenom-livreur-${codeID}`).value;
              const idLivreur = document.getElementById(`id-livreur-${codeID}`).value;

              if (!nomLivreur || !prenomLivreur || !idLivreur) {
                showToast('Veuillez remplir tous les champs obligatoires', 'warning');
                return;
              }

              confirmBtn.disabled = true;
              confirmBtn.querySelector('.btn-inner').style.display = 'none';
              confirmBtn.querySelector('.btn-loading').style.display = 'inline-block';
              cancelBtn.disabled = true;

              try {
                const res = await fetch('/.netlify/functions/deleteLivraison', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ 
                    codeID, 
                    nomLivreur, 
                    prenomLivreur, 
                    idLivreur 
                  }),
                });

                const data = await res.json();

                if (res.ok) {
                  showToast('Livraison terminée avec succès', 'success');
                  card.classList.add('animate__animated', 'animate__fadeOut');
                  setTimeout(() => {
                    card.remove();
                    if (!document.querySelectorAll('.card').length) {
                      colisList.innerHTML = '<div class="empty-state">🎉 Tous les colis ont été livrés !</div>';
                    }
                  }, 300);
                } else {
                  confirmBtn.disabled = false;
                  confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                  confirmBtn.querySelector('.btn-loading').style.display = 'none';
                  cancelBtn.disabled = false;
                  showToast(data.error || 'Erreur lors de la finalisation', 'error');
                }
              } catch (e) {
                confirmBtn.disabled = false;
                confirmBtn.querySelector('.btn-inner').style.display = 'inline-block';
                confirmBtn.querySelector('.btn-loading').style.display = 'none';
                cancelBtn.disabled = false;
                showToast('Erreur de connexion au serveur', 'error');
              }
            });
          });
        });
      }

      function setupLocationUpdateButton(cardElement) {
        const updateButton = cardElement.querySelector('.update-location-btn');
        if (updateButton) {
          updateButton.addEventListener('click', async () => {
            const codeID = updateButton.dataset.id;
            updateButton.disabled = true;
            updateButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Mise à jour...';

            if (navigator.geolocation) {
              showToast('🛰️ Tentative de mise à jour de votre position...', 'info');
              navigator.geolocation.getCurrentPosition(async (position) => {
                const nouvelleLocalisation = {
                  latitude: position.coords.latitude,
                  longitude: position.coords.longitude,
                };

                try {
                  const res = await fetch('/.netlify/functions/mettreAJourLocalisation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ codeID: codeID, localisation: nouvelleLocalisation }),
                  });

                  const data = await res.json();

                  if (res.ok) {
                    updateButton.innerHTML = '<i class="fas fa-map-marker-alt mr-2 text-success"></i> Position mise à jour !';
                    showToast('📍 Votre position a été mise à jour avec succès !', 'success');
                    setTimeout(() => {
                      updateButton.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i> Actuliser ma position';
                      updateButton.disabled = false;
                    }, 3000);
                  } else {
                    updateButton.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Erreur';
                    updateButton.disabled = false;
                    showToast(`❌ Erreur lors de la mise à jour: ${data.error || 'Une erreur inconnue est survenue'}`, 'error');
                  }
                } catch (error) {
                  updateButton.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Erreur';
                  updateButton.disabled = false;
                  showToast('⚡ Erreur de connexion lors de la mise à jour', 'error');
                }
              }, (error) => {
                updateButton.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i> Actuliser ma position';
                updateButton.disabled = false;
                let errorMessage = 'Erreur lors de la récupération de la localisation.';
                if (error.code === error.PERMISSION_DENIED) {
                  errorMessage = '⚠️ Autorisation de localisation refusée.';
                } else if (error.code === error.POSITION_UNAVAILABLE) {
                  errorMessage = '📍 Position indisponible.';
                } else if (error.code === error.TIMEOUT) {
                  errorMessage = '⏳ Délai d\'attente pour la localisation dépassé.';
                }
                showToast(errorMessage, 'warning');
              });
            } else {
              updateButton.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i> Actuliser ma position';
              updateButton.disabled = false;
              showToast('🌐 La géolocalisation n\'est pas supportée par votre navigateur.', 'error');
            }
          });
        }
      }

      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;

        const closeBtn = document.createElement('span');
        closeBtn.textContent = '×';
        closeBtn.className = 'close-btn';
        closeBtn.onclick = () => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        };
        toast.appendChild(closeBtn);

        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);

        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }

      // Démarrer l'application
      getLocation();

      // Rafraîchir toutes les 5 minutes
      setInterval(fetchColis, 300000);
    });
  </script>
</body>
</html>